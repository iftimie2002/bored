<!doctype html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { max-width: 760px; margin: 22px auto; }
    .timer-ring { transition: stroke-dashoffset 0.3s linear; }
    .option-btn { transition: all 0.2s; }
    .option-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    .option-btn.selected { background-color: #6366f1; color: white; border-color: #6366f1; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-pink-50 min-h-screen font-sans">
  <div class="card p-8 bg-white/90 rounded-3xl shadow-2xl">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Are you Smart, or just Confident?</h1>
      <div id="progress" class="text-lg text-slate-600">Question <span id="qix">0</span>/<span id="qtotal">0</span></div>
    </div>
    <div id="container" class="min-h-96"></div>
    <div class="mt-8 flex justify-between items-center">
      <button id="backBtn" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-medium">← Back</button>
      <div id="status" class="text-sm text-slate-500">Autosave: idle</div>
    </div>
  </div>

<script>
(function(){
  // ====================== FACT QUESTIONS ======================
  const trueFalseQuestions = [
    {type:"tf", q:'A cloud weighs around a million tons.', correct:true},
    {type:"tf", q:'Giraffes are 30x more likely to be struck by lightning than humans.', correct:true},
    {type:"tf", q:'Identical twins have identical fingerprints.', correct:false},
    {type:"tf", q:"The Earth's rotation is speeding up.", correct:false},
    {type:"tf", q:'Your brain literally eats itself every day.', correct:true},
    {type:"tf", q:'Mars is shaped more like a rugby ball than a sphere.', correct:true},
    {type:"tf", q:"The universe's average colour is officially called Cosmic Latte.", correct:true},
    {type:"tf", q:'Water itself is not wet — only objects touching it are.', correct:true},
    {type:"tf", q:'A chicken once lived for 18 months without its head.', correct:true},
    {type:"tf", q:'There are more bacterial cells in your body than human cells.', correct:true},
    {type:"tf", q:"Octopuses don't have tentacles — only arms.", correct:true},
    {type:"tf", q:'Most maps you see in school are actually wrong.', correct:true},
    {type:"tf", q:'Snails can have over 10,000 teeth.', correct:true},
    {type:"tf", q:'Lightning is hotter than the surface of the Sun.', correct:true},
    {type:"tf", q:'Bananas are slightly radioactive.', correct:true},
    {type:"tf", q:'You travel millions of kilometres every day without realising it.', correct:true},
    {type:"tf", q:'You can fold a piece of A4 paper more than eight times.', correct:false},
    {type:"tf", q:'A penguin has been recorded diving deeper than 500 metres.', correct:true},
    {type:"tf", q:'There is a planet made mostly of diamond.', correct:true},
    {type:"tf", q:'The Moon is growing larger every year.', correct:false}
  ];

  const mcQuestions = [
    {type:"mc", q:"What are the prime factors of 24?", options:["Two and three","Two and four","Three and eight","Two and twelve"], correct:0},
    {type:"mc", q:"How many sides does a trapezoid have?", options:["Three","Four","Five","Six"], correct:1},
    {type:"mc", q:"Which theorem: in a right triangle A² + B² = C²?", options:["Euclid","Pythagorean Theorem","Fermat","Pascal"], correct:1},
    {type:"mc", q:"How many degrees in a circle?", options:["180","270","360","365"], correct:2},
    {type:"mc", q:"How many yards in a mile?", options:["1000","1760","2000","5280"], correct:1},
    {type:"mc", q:"What produces most breathable oxygen?", options:["Trees","Grass","The oceans","Rainforests"], correct:2},
    {type:"mc", q:"Which is faster: sound or light?", options:["Sound","Light","Same","Depends"], correct:1},
    {type:"mc", q:"What mineral makes things float easier in water?", options:["Sugar","Salt","Iron","Baking soda"], correct:1},
    {type:"mc", q:"Earth spin speed at equator (mph)?", options:["500","1000","1500","2000"], correct:1},
    {type:"mc", q:"Elements on periodic table (2025)?", options:["92","108","118","124"], correct:2},
    {type:"mc", q:"Universal blood donor?", options:["AB+","A-","O-","B+"], correct:2},
    {type:"mc", q:"Neptune moons (2025)?", options:["8","14","27","63"], correct:1},
    {type:"mc", q:"Disease eradicated 1980?", options:["Polio","Measles","Smallpox","Malaria"], correct:2},
    {type:"mc", q:"First American woman in space?", options:["Tereshkova","Jemison","Sally Ride","Resnik"], correct:2},
    {type:"mc", q:"Pounds in a US ton?", options:["1000","2000","2204","2240"], correct:1},
    {type:"mc", q:"Largest human bone?", options:["Tibia","Femur","Humerus","Spine"], correct:1},
    {type:"mc", q:"Planets in solar system?", options:["7","8","9","10"], correct:1},
    {type:"mc", q:"Colors in a rainbow?", options:["6","7","8","Infinite"], correct:1},
    {type:"mc", q:"Astronomer in “Bohemian Rhapsody”?", options:["Copernicus","Kepler","Galileo","Newton"], correct:2},
    {type:"mc", q:"Fear of flowers?", options:["Floraphobia","Anthophobia","Botanophobia","Petalphobia"], correct:1}
  ];

  // ====================== ALL STAR QUESTIONS (18 total) ======================
  const starQuestions = [
    {id:"s1", text:"What's the one thing in the Algarve that genuinely surprised you in a good way?"},
    {id:"s2", text:"What part of your stay felt unnecessarily difficult or annoying?"},
    {id:"s3", text:"What service or product do you wish had been available here?"},
    {id:"s4", text:"What did you try to do in the Algarve that ended up being harder than expected?"},
    {id:"s5", text:"What’s something you looked for but couldn’t find easily?"},
    {id:"s6", text:"What daily task would you pay someone to handle for you while staying here?"},
    {id:"s7", text:"What’s one thing that would have saved you time during your trip?"},
    {id:"s8", text:"What place or service felt outdated or in need of improvement?"},
    {id:"s9", text:"What’s something from home you kept thinking “I wish they had this here”?"},
    {id:"s10", text:"What activity or experience did you expect to exist but didn’t?"},
    {id:"s11", text:"What moment made you think “this could be done in a better way”?"},
    {id:"s12", text:"What did you spend too much effort trying to figure out or organize?"},
    {id:"s13", text:"What local service disappointed you the most?"},
    {id:"s14", text:"What would have made your stay more comfortable on a daily basis?"},
    {id:"s15", text:"What’s something you felt was overpriced for the value?"},
    {id:"s16", text:"If you could bring one thing from back home to make your stay easier, what would it be?"},
    {id:"s17", text:"What’s one thing that would have improved your stay immediately?"},
    {id:"s18", text:"What’s something you expected to find here but didn't?"}
  ];

  // ====================== VERDICTS ======================
  const lowVerdicts = ["Ouch… but confidence is half the battle!","You may not know much, but you know how to commit.","Trivia night champion? Maybe not. Fun drinking buddy? Absolutely.","Your brain was clearly on holiday too.","You're running on a very custom OS."];
  const midVerdicts = ["Confidence and knowledge are fighting… it's a draw.","You're smart enough to be dangerous.","Diet Einstein.","You'd do well on a game show… with phone-a-friend."];
  const highVerdicts = ["NASA is calling.","You're why group projects succeed.","People quietly hate you in pubs.","You're one search away from being everyone's Google."];

  let answers = {};
  let sequence = [];
  let pointer = 0;
  let stage = 'meta';
  let timerInterval = null;
  let timeLeft = 30;
  const clientId = localStorage.getItem('clientId') || ('id-'+Math.random().toString(36).slice(2)+Date.now());
  localStorage.setItem('clientId', clientId);

  const container = document.getElementById('container');
  const qix = document.getElementById('qix');
  const qtotal = document.getElementById('qtotal');
  const status = document.getElementById('status');
  const backBtn = document.getElementById('backBtn');

  function shuffle(a) { const b=[...a]; for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];} return b; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function renderMeta(){
    stage = 'meta'; pointer = 0; qix.textContent='0'; qtotal.textContent='0'; backBtn.disabled=true;
    container.innerHTML = `
      <div class="space-y-10 text-center">
        <h2 class="text-3xl font-bold text-slate-800">Welcome to the Algarve Feedback + Brain Teaser</h2>
        <div class="space-y-8 max-w-md mx-auto">
          <div>
            <label class="block text-xl font-semibold mb-3">How long are you staying?</label>
            <select id="meta_q1" class="w-full text-lg rounded-xl border-2 border-slate-300 p-4">
              <option value="leaving">Leaving today/tomorrow</option>
              <option value="few">Few more days</option>
              <option value="week">1–2 weeks</option>
              <option value="just">Just arrived</option>
              <option value="not">Not in the Algarve</option>
            </select>
          </div>
          <div>
            <label class="block text-xl font-semibold mb-3">How many minutes is your ride?</label>
            <div class="flex items-center gap-4">
              <input id="meta_q3" type="range" min="1" max="60" value="12" class="w-full">
              <span id="minsVal" class="text-3xl font-mono w-20 text-right">12</span>
            </div>
          </div>
          <button id="startBtn" class="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold rounded-2xl">Start →</button>
        </div>
      </div>`;
    const saved = JSON.parse(localStorage.getItem('survey_draft')||'null');
    if(saved?.meta){ if(saved.meta.q1) document.getElementById('meta_q1').value = saved.meta.q1;
      if(saved.meta.q3){ document.getElementById('meta_q3').value = saved.meta.q3; document.getElementById('minsVal').textContent = saved.meta.q3; }
    }
    document.getElementById('meta_q3').oninput = e => document.getElementById('minsVal').textContent = e.target.value;
    document.getElementById('startBtn').onclick = startSurvey;
  }

  function startSurvey(){
    buildSequence();
    stage = 'survey'; pointer = 0;
    renderCurrent();
  }

  function buildSequence(){
    const mins = Number(document.getElementById('meta_q3').value || 12);
    const maxFact = mins < 6 ? 5 : mins < 15 ? 10 : 16;
    const maxStar = mins < 6 ? 2 : mins < 15 ? 5 : 8;

    const shuffledStars = shuffle(starQuestions).slice(0, maxStar);
    const allFacts = shuffle([...trueFalseQuestions, ...mcQuestions]).slice(0, maxFact);

    sequence = [];
    let factsSinceStar = 0;
    let starIdx = 0;

    allFacts.forEach(fact => {
      sequence.push({type:'fact', ...fact});
      factsSinceStar++;
      if ((factsSinceStar === 2 && Math.random() < 0.7) || factsSinceStar >= 3) {
        if (starIdx < shuffledStars.length) {
          sequence.push({type:'star', ...shuffledStars[starIdx++]});
          factsSinceStar = 0;
        }
      }
    });
    while (starIdx < shuffledStars.length) sequence.push({type:'star', ...shuffledStars[starIdx++]});

    qtotal.textContent = sequence.length;
  }

  function startTimer(){
    timeLeft = 30;
    const timerHTML = `<div class="flex justify-center mb-8">
      <svg width="110" height="110"><circle cx="55" cy="55" r="48" stroke="#e5e7eb" stroke-width="10" fill="none"/>
      <circle id="timerRing" cx="55" cy="55" r="48" stroke="#10b981" stroke-width="10" fill="none" stroke-dasharray="301.6" class="timer-ring"/>
      <text id="timerText" x="55" y="62" font-size="36" text-anchor="middle" font-weight="bold" fill="#1f2937">30</text></svg></div>`;
    if (!document.getElementById('timerRing')) container.insertAdjacentHTML('afterbegin', timerHTML);
    renderTimer();
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timeLeft--;
      renderTimer();
      if (timeLeft <= 0) { clearInterval(timerInterval); const cur = sequence[pointer]; answers[cur.q] = {answer:null, confidence:0, timedOut:true}; nextQuestion(); }
    }, 1000);
  }

  function renderTimer(){
    if (!document.getElementById('timerRing')) return;
    const circ = 301.6;
    const offset = circ - (timeLeft/30)*circ;
    document.getElementById('timerRing').style.strokeDashoffset = offset;
    document.getElementById('timerText').textContent = timeLeft;
    document.getElementById('timerRing').style.stroke = timeLeft > 10 ? '#10b981' : timeLeft > 5 ? '#f59e0b' : '#ef4444';
  }

  function renderFact(item){
    qix.textContent = pointer + 1; backBtn.disabled = pointer === 0; startTimer();
    let html = '<div class="space-y-8">';
    if (item.type === 'tf') {
      html += `<h2 class="text-3xl font-bold text-center leading-relaxed text-slate-800">${esc(item.q)}</h2>
        <div class="flex justify-center gap-10">
          <button class="true-btn px-16 py-8 bg-green-600 hover:bg-green-700 text-white text-3xl font-bold rounded-3xl shadow-xl">TRUE</button>
          <button class="false-btn px-16 py-8 bg-red-600 hover:bg-red-700 text-white text-3xl font-bold rounded-3xl shadow-xl">FALSE</button>
        </div></div>`;
      container.innerHTML = html;
      document.querySelector('.true-btn').onclick = () => selectAnswer(true);
      document.querySelector('.false-btn').onclick = () => selectAnswer(false);
    } else {
      const opts = item.options.map((o,i) => `<button data-idx="${i}" class="option-btn p-6 text-xl font-medium border-2 border-slate-300 rounded-2xl text-left hover:border-indigo-500">${esc(o)}</button>`).join('');
      html += `<h2 class="text-3xl font-bold text-center leading-relaxed text-slate-800">${esc(item.q)}</h2>
        <div class="grid gap-4 max-w-3xl mx-auto">${opts}</div></div>`;
      container.innerHTML = html;
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.option-btn').forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          clearInterval(timerInterval);
          answers[item.q] = {answer: Number(btn.dataset.idx)};
          setTimeout(() => renderConfidence(item.q), 500);
        };
      });
    }
  }

  function selectAnswer(val){
    clearInterval(timerInterval);
    answers[sequence[pointer].q] = {answer: val};
    renderConfidence(sequence[pointer].q);
  }

  function renderConfidence(key){
    clearInterval(timerInterval);
    container.innerHTML = `
      <div class="text-center space-y-10">
        <h2 class="text-3xl font-bold text-slate-800">How confident are you?</h2>
        <input id="confSlider" type="range" min="0" max="100" value="65" class="w-full h-4 rounded-lg appearance-none cursor-pointer bg-slate-200">
        <div id="confVal" class="text-6xl font-extrabold text-indigo-600">65%</div>
        <button id="confNext" class="px-12 py-5 bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-bold rounded-2xl">Continue →</button>
      </div>`;
    const slider = document.getElementById('confSlider');
    const val = document.getElementById('confVal');
    slider.oninput = () => val.textContent = slider.value + '%';
    document.getElementById('confNext').onclick = () => {
      answers[key].confidence = Number(slider.value);
      nextQuestion();
    };
  }

  function renderStar(item){
    clearInterval(timerInterval);
    qix.textContent = pointer + 1; backBtn.disabled = pointer === 0;
    const saved = answers[item.id]?.answer || '';
    container.innerHTML = `
      <div class="space-y-8">
        <h2 class="text-3xl font-bold text-slate-800 leading-relaxed">${esc(item.text)}</h2>
        <textarea id="starInput" rows="5" class="w-full text-lg rounded-xl border-2 border-slate-300 p-4 focus:border-indigo-500 resize-none" placeholder="Your thoughts…">${saved}</textarea>
        <div class="text-right"><button id="starNext" class="px-10 py-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold rounded-xl">Next →</button></div>
      </div>`;
    document.getElementById('starNext').onclick = () => {
      answers[item.id] = {answer: document.getElementById('starInput').value.trim()};
      nextQuestion();
    };
  }

  function nextQuestion(){ pointer++; if(pointer >= sequence.length) finishSurvey(); else renderCurrent(); }

  function renderCurrent(){
    const item = sequence[pointer];
    if(item.type==='fact') renderFact(item);
    else renderStar(item);
  }

  backBtn.onclick = () => { if(pointer>0){ pointer--; clearInterval(timerInterval); renderCurrent(); }};

  function finishSurvey(){
    clearInterval(timerInterval); localSave();

    const facts = sequence.filter(x=>x.type==='fact');
    let correct = 0, confSum = 0;
    facts.forEach(f => {
      const a = answers[f.q] || {answer:null, confidence:0};
      const right = (f.type==='tf' && a.answer===f.correct) || (f.type==='mc' && a.answer===f.correct);
      if(right) correct++;
      confSum += Number(a.confidence || 0);
    });
    const smartScore = facts.length ? Math.round(correct/facts.length*100) : 0;
    const confidenceScore = facts.length ? Math.round(confSum/facts.length) : 0;

    let verdict = '';
    if(smartScore < 35) verdict = lowVerdicts[Math.floor(Math.random()*lowVerdicts.length)];
    else if(smartScore < 65) verdict = midVerdicts[Math.floor(Math.random()*midVerdicts.length)];
    else verdict = highVerdicts[Math.floor(Math.random()*highVerdicts.length)];

    let answerList = '';
    facts.forEach(f => {
      const a = answers[f.q] || {};
      const user = f.type==='tf' ? (a.answer===true?'True':a.answer===false?'False':'Timed out') :
                   f.type==='mc' ? (a.answer!=null ? f.options[a.answer] : 'Timed out') : '';
      const corr = f.type==='tf' ? (f.correct?'True':'False') : f.options[f.correct];
      answerList += `<div class="border-b py-5"><div class="font-semibold mb-1">${esc(f.q)}</div>
        <div class="text-slate-600">You: <span class="font-medium text-slate-900">${esc(user)}</span></div>
        <div class="text-green-600">Correct: <span class="font-medium">${esc(corr)}</span></div></div>`;
    });

    container.innerHTML = `
      <div class="text-center space-y-12">
        <h2 class="text-4xl font-bold text-slate-800">Results</h2>
        <div class="grid grid-cols-2 gap-8 max-w-md mx-auto">
          <div class="p-8 bg-indigo-100 rounded-3xl"><div class="text-xl font-semibold">Smart Score</div><div class="text-6xl font-extrabold text-indigo-700">${smartScore}</div></div>
          <div class="p-8 bg-pink-100 rounded-3xl"><div class="text-xl font-semibold">Confidence</div><div class="text-6xl font-extrabold text-pink-700">${confidenceScore}</div></div>
        </div>
        <p class="text-2xl font-medium text-slate-700 max-w-4xl mx-auto">${esc(verdict)}</p>

        <div class="max-w-4xl mx-auto bg-slate-50 rounded-3xl p-8 text-left">
          <h3 class="text-2xl font-bold mb-6">Your Fact Answers</h3>
          ${answerList}
        </div>

        <div class="flex justify-center gap-6">
          <button id="moreBtn" class="px-8 py-4 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">More questions</button>
          <button id="restartBtn" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold">Retake Survey</button>
        </div>
      </div>`;

    document.getElementById('moreBtn').onclick = () => { sequence = shuffle([...trueFalseQuestions, ...mcQuestions]); pointer=0; renderCurrent(); };
    document.getElementById('restartBtn').onclick = () => { answers={}; renderMeta(); };

    try { google.script.run.submitResponse({clientId, answers, smartScore, confidenceScore}); } catch(e) {}
  }

  function localSave(){
    const meta = {q1: document.getElementById('meta_q1')?.value, q3: document.getElementById('meta_q3')?.value};
    localStorage.setItem('survey_draft', JSON.stringify({clientId, meta, answers}));
  }

  setInterval(() => { localSave(); status.textContent='Autosaved'; }, 8000);

  renderMeta();
})();
</script>
</body>
</html>
