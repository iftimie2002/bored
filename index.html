<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>How Smart are You?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- Retro pixel font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

  <style>
    html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .container { padding: env(safe-area-inset-top, 1rem) env(safe-area-inset-right, 0.5rem) max( env(safe-area-inset-bottom, 1.5rem), 2rem ) env(safe-area-inset-left, 0.5rem); }
    .timer-ring { transition: stroke-dashoffset 0.35s ease; }

    /* ========= PRISONER'S DILEMMA: RETRO FIELD GAME STYLES ========= */

    .pd-game-outer {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border-radius: 18px;
      padding: 8px;
      background: #111827;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      image-rendering: pixelated;
      font-family: "Press Start 2P", system-ui, sans-serif;
    }

    /* “Gameboy” frame */
    .pd-game-shell {
      border-radius: 14px;
      padding: 6px;
      background: #27272f;
      border: 3px solid #4b5563;
      position: relative;
      overflow: hidden;
    }

    .pd-game-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: repeating-linear-gradient(
        135deg,
        rgba(255,255,255,0.04) 0,
        rgba(255,255,255,0.04) 2px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
    }

    /* Top HUD */
    .pd-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 8px;
      color: #e5e7eb;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .pd-hud-label {
      background: #000;
      padding: 4px 6px;
      border-radius: 6px;
      border: 2px solid #6b7280;
      box-shadow: 0 0 0 2px #000;
    }

    .pd-hud-timer {
      background: #0f172a;
      padding: 4px 8px;
      border-radius: 999px;
      border: 2px solid #facc15;
      color: #facc15;
      font-size: 9px;
      box-shadow: 0 0 0 2px #000;
      min-width: 58px;
      text-align: center;
    }

    .pd-hud-scorebox {
      display: flex;
      gap: 4px;
      font-size: 7px;
    }

    .pd-hud-chip {
      background: #000;
      padding: 3px 5px;
      border-radius: 6px;
      border: 2px solid #4ade80;
      box-shadow: 0 0 0 2px #000;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pd-hud-chip span {
      white-space: nowrap;
    }

    .pd-hud-chip-ai {
      border-color: #f97373;
    }

    .pd-score-value {
      background: #111;
      padding: 3px 4px;
      border-radius: 4px;
      min-width: 18px;
      text-align: center;
    }

    /* Field + characters */

    .pd-field {
      position: relative;
      margin-top: 4px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid #374151;
      box-shadow: 0 0 0 2px #111827;
      background:
        linear-gradient(#60a5fa 0%, #60a5fa 45%, #22c55e 45%, #16a34a 100%);
      padding: 24px 10px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pd-cloud {
      position: absolute;
      top: 6px;
      width: 46px;
      height: 18px;
      background: #e5f2ff;
      border-radius: 8px;
      box-shadow:
        10px 0 0 #e5f2ff,
        -10px 0 0 #e5f2ff,
        0 6px 0 #e5f2ff;
      filter: drop-shadow(0 0 2px rgba(15,23,42,0.5));
      animation: cloud-drift 12s linear infinite;
    }

    .pd-cloud.cloud2 {
      top: 14px;
      animation-duration: 18s;
      opacity: 0.8;
    }

    .pd-cloud.cloud3 {
      top: 2px;
      animation-duration: 22s;
      opacity: 0.65;
    }

    @keyframes cloud-drift {
      0%   { transform: translateX(-60px); }
      100% { transform: translateX(260px); }
    }

    .pd-field-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 6px;
      z-index: 1;
    }

    .pd-character {
      width: 40px;
      height: 40px;
      background: #facc15;
      border-radius: 4px;
      box-shadow:
        0 0 0 3px #000,
        0 4px 0 #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: char-bob 0.7s ease-in-out infinite alternate;
    }

    .pd-character-ai {
      background: #fb7185;
    }

    @keyframes char-bob {
      from { transform: translateY(1px); }
      to   { transform: translateY(-3px); }
    }

    .pd-face {
      width: 26px;
      height: 18px;
      background: #fde68a;
      border-radius: 2px;
      box-shadow: 0 0 0 2px #000;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 1px;
      padding: 2px;
    }

    .pd-pixel {
      width: 100%;
      height: 100%;
      background: transparent;
    }

    .pd-pixel-eye {
      background: #000;
    }

    .pd-pixel-mouth {
      background: #000;
    }

    .pd-label-under {
      margin-top: 4px;
      text-align: center;
      font-size: 7px;
      color: #111827;
      text-shadow: 0 1px 0 #f9fafb;
    }

    .pd-middle {
      text-align: center;
      font-size: 8px;
      color: #0f172a;
      padding: 4px 6px;
      background: rgba(248, 250, 252, 0.9);
      border-radius: 6px;
      box-shadow: 0 0 0 2px #0f172a;
      margin: 0 8px;
    }

    .pd-middle span {
      display: block;
      margin-top: 2px;
      font-size: 7px;
      color: #4b5563;
    }

    /* Controls */

    .pd-controls {
      display: flex;
      gap: 8px;
      margin: 4px 4px 2px;
      z-index: 1;
    }

    .pd-btn {
      flex: 1;
      border: 0;
      outline: none;
      cursor: pointer;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      padding: 9px 4px;
      background: #e5e7eb;
      color: #111827;
      border-radius: 6px;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s ease;
    }

    .pd-btn-primary {
      background: #4f46e5;
      color: #f9fafb;
    }

    .pd-btn-small {
      flex: 0 0 auto;
      font-size: 8px;
      padding: 7px 6px;
      background: #fecaca;
    }

    .pd-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
      filter: brightness(0.85);
    }

    .pd-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.4);
    }

    /* Message + history */

    .pd-message-box {
      margin: 4px 4px 2px;
      padding: 6px 6px 4px;
      border-radius: 8px;
      background: #020617;
      box-shadow: 0 0 0 2px #000;
      font-size: 8px;
      color: #e5e7eb;
      z-index: 1;
    }

    .pd-msg {
      min-height: 1.6em;
      margin-bottom: 3px;
    }

    .pd-msg-info { color: #e5e7eb; }
    .pd-msg-good { color: #4ade80; }
    .pd-msg-bad  { color: #f97373; }
    .pd-msg-warn { color: #fbbf24; }

    .pd-history {
      max-height: 82px;
      overflow-y: auto;
      padding: 4px;
      background: #020617;
      border-radius: 6px;
      box-shadow: inset 0 0 0 1px #111827;
      font-size: 7px;
    }

    .pd-history-entry {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1px;
      color: #9ca3af;
    }

    .pd-history-entry span {
      white-space: nowrap;
    }

    .pd-continue-wrap {
      margin-top: 5px;
      padding: 0 4px 2px;
    }

    .pd-continue-btn {
      width: 100%;
      border-radius: 8px;
      border: 0;
      outline: 0;
      padding: 9px 4px;
      background: #22c55e;
      color: #052e16;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease;
    }

    .pd-continue-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
    }

    @media (max-width: 400px) {
      .pd-hud {
        font-size: 7px;
      }
      .pd-hud-timer {
        font-size: 8px;
      }
      .pd-btn {
        font-size: 8px;
      }
      .pd-continue-btn {
        font-size: 8px;
      }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.8.6/jsrsasign-all.min.js"></script>
</head>

<body class="h-full text-slate-900 dark:text-slate-100 transition-colors duration-300 bg-gradient-to-br from-indigo-50 via-white to-pink-50 dark:from-slate-900 dark:via-slate-950 dark:to-purple-950">

  <div id="app" class="h-full flex flex-col"></div>

  <!-- STATUS BAR -->
  <div id="status" style="text-align:center; margin:8px; font-weight:bold;"></div>

<script>
(function(){
  if (window.matchMedia('(prefers-color-scheme: dark)').matches)
    document.documentElement.classList.add('dark');

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    document.documentElement.classList.toggle('dark', e.matches);
  });

  // IP do cliente (async)
  let clientIp = null;

  function loadClientIp() {
    try {
      fetch('https://api.ipify.org?format=json')
        .then(r => r.json())
        .then(d => {
          clientIp = d.ip;
          console.log('clientIp =', clientIp);
        })
        .catch(err => {
          console.warn('IP lookup failed', err);
          clientIp = null;
        });
    } catch (err) {
      console.warn('fetch not available', err);
      clientIp = null;
    }
  }

  loadClientIp();

  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyHCDKhMagLW7tlHq3dZZ9tPQAZQmA0hMKMut9amF67dEPsoWV1X2RcmSKSFIujp7mD/exec';
  const PUBLIC_KEY_PEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxWwSLTeQoGM5Gvb9yBBJ
7Q4CFpNu3baUSEfm3NJb5LI59HdM66o3h0Sl2RTbwW2Q9zK1kDqLTf/J5kMnwtU9
GKcEuKD1UYWvzZO9C/ekPoKhzMWccdFujIrTeLPJGjncSr0QZ9ZfAoSAYMamdtlR
lfsNZjrUwEL9NsrPd4RMgaYHAI28TlceDhObgZPzjwBPOy0zEQiqW6NA+eQh88ES
/CKvTjFt8E+jZzmFdqPFKHZ56scmThT7VK1IisRCnQFSRKqyKXBBg9C5Qmro7+3p
KiZAS/mG2QMYEwpVeJ5GzvH3ENBgNBps84YivNU0P0OtJ1vz24meWgemkppqadr+
ZwIDAQAB
-----END PUBLIC KEY-----`;

  function pemToArrayBuffer(pem) {
    const b64 = pem.replace(/-----[^-]+-----/g, '').replace(/\s+/g, '');
    const raw = atob(b64);
    const buffer = new ArrayBuffer(raw.length);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < raw.length; i++) view[i] = raw.charCodeAt(i);
    return buffer;
  }

  async function encryptPayload(payload) {
    const rsaPub = KEYUTIL.getKey(PUBLIC_KEY_PEM);

    const plaintextJson = JSON.stringify(payload);

    const aesKey = CryptoJS.lib.WordArray.random(32);
    const iv = CryptoJS.lib.WordArray.random(16);

    const encrypted = CryptoJS.AES.encrypt(plaintextJson, aesKey, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });

    const ciphertextB64 = encrypted.ciphertext.toString(CryptoJS.enc.Base64);
    const ivB64 = CryptoJS.enc.Base64.stringify(iv);
    const aesKeyB64 = CryptoJS.enc.Base64.stringify(aesKey);

    const hexCipher = rsaPub.encryptOAEP(aesKeyB64, 'sha256');
    const wrappedKeyB64 = hextob64(hexCipher);

    return {
      key: wrappedKeyB64,
      iv: ivB64,
      ciphertext: ciphertextB64
    };
  }

  async function sendEncryptedPayload(payload) {
    try {
      const envelope = await encryptPayload(payload);
      await fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(envelope)
      });
      setStatus('Sent test ping');
    } catch (err) {
      console.error('Failed to send encrypted payload', err);
      setStatus('Error sending payload');
    }
  }

  let saveTimeout;

  function getClientInfo() {
    const colorScheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const href = window.location.href;
    const referrer = document.referrer || '';
    const urlParams = new URLSearchParams(window.location.search || '');
    const utm = {
      utm_source: urlParams.get('utm_source') || '',
      utm_medium: urlParams.get('utm_medium') || '',
      utm_campaign: urlParams.get('utm_campaign') || ''
    };

    return {
      userAgent: navigator.userAgent,
      language: navigator.language,
      languages: navigator.languages,
      platform: navigator.platform,
      deviceMemory: navigator.deviceMemory ?? null,
      hardwareConcurrency: navigator.hardwareConcurrency ?? null,
      timezone: tz,
      colorScheme,
      screen: {
        width: window.screen?.width ?? null,
        height: window.screen?.height ?? null,
        pixelDepth: window.screen?.pixelDepth ?? null
      },
      connection: navigator.connection ? {
        effectiveType: navigator.connection.effectiveType,
        downlink: navigator.connection.downlink,
        rtt: navigator.connection.rtt
      } : null,
      clientIp: clientIp,
      url: href,
      referrer,
      utm
    };
  }

  // IMPORTANT CHANGE: strip Prisoner's Dilemma answer before sending
  function autoSave(isFinal = false) {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      const answersForSheets = Object.fromEntries(
        Object.entries(answers).filter(([key]) => key !== pdGameId)
      );

      const payload = {
        meta: {
          stay: document.getElementById('stay')?.value || null,
          mins: document.getElementById('mins')?.value || null,
          client: getClientInfo()
        },
        answers: answersForSheets,
        sequence: sequence.map(q =>
          q.type === 'star'
            ? { type: 'star', id: q.id }
            : { type: 'fact', q: q.q }
        ),
        pointer: pointer
      };
      if (isFinal) {
        payload.smartScore = smart;
        payload.starIds = sequence.filter(q => q.type === 'star').map(q => q.id);
      }
      const encryptedPayload = {
        clientId,
        timestamp: new Date().toISOString(),
        ...payload
      };

      sendEncryptedPayload(encryptedPayload);
    }, 800);
  }

  async function sendTestRow() {
    const payload = {
      clientId,
      timestamp: new Date().toISOString(),
      meta: { test: true, note: 'manual ping from UI', client: getClientInfo() },
      answers: { sample: { answer: 'ping' } },
      sequence: [{ type: 'info', q: 'connectivity check' }],
      pointer: 0,
      smartScore: 0,
      testPing: true
    };

    setStatus('Sending test ping…');
    await sendEncryptedPayload(payload);
    setStatus('Test ping sent!');
  }

  let clientId = localStorage.getItem('surveyClientId');
  if (!clientId) {
    clientId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
    localStorage.setItem('surveyClientId', clientId);
  }

  const trueFalseQuestions = [
    {type:"tf", q:'A cloud weighs around a million tons.', correct:true},
    {type:"tf", q:'Giraffes are 30x more likely to be struck by lightning than humans.', correct:true},
    {type:"tf", q:'Identical twins have identical fingerprints.', correct:false},
    {type:"tf", q:"The Earth's rotation is speeding up.", correct:false},
    {type:"tf", q:'Your brain eats itself every day.', correct:true},
    {type:"tf", q:'Mars is shaped more like a rugby ball.', correct:true},
    {type:"tf", q:"The universe's average colour is Cosmic Latte.", correct:true},
    {type:"tf", q:'Water is not wet.', correct:true},
    {type:"tf", q:'A chicken lived 18 months without its head.', correct:true},
    {type:"tf", q:'More bacterial cells than human cells.', correct:true},
    {type:"tf", q:"Octopuses have arms, not tentacles.", correct:true},
    {type:"tf", q:'Most school maps are wrong.', correct:true},
    {type:"tf", q:'Snails can have 10,000+ teeth.', correct:true},
    {type:"tf", q:'Lightning is hotter than the Sun surface.', correct:true},
    {type:"tf", q:'Bananas are radioactive.', correct:true},
    {type:"tf", q:'You travel millions of km daily.', correct:true},
    {type:"tf", q:'You can fold A4 more than eight times.', correct:false},
    {type:"tf", q:'Penguin recorded diving 500m+', correct:true},
    {type:"tf", q:'There is a diamond planet.', correct:true},
    {type:"tf", q:'The Moon grows each year.', correct:false}
  ];

  const mcQuestions = [
    {type:"mc", q:"Prime factors of 24?", options:["Two and three","Two and four","Three and eight","Two and twelve"], correct:0},
    {type:"mc", q:"Sides of a trapezoid?", options:["Three","Four","Five","Six"], correct:1},
    {type:"mc", q:"A² + B² = C² theorem?", options:["Euclid","Pythagoras","Fermat","Pascal"], correct:1},
    {type:"mc", q:"Degrees in a circle?", options:["180","270","360","365"], correct:2},
    {type:"mc", q:"Yards in a mile?", options:["1000","1760","2000","5280"], correct:1},
    {type:"mc", q:"Majority of breathable air comes from?", options:["Trees","Grass","Oceans","Rainforest algae"], correct:2},
    {type:"mc", q:"Faster: Sound or light?", options:["Sound","Light","Same","Depends"], correct:1},
    {type:"mc", q:"Add this to water to float easier:", options:["Sugar","Salt","Iron","Baking soda"], correct:1},
    {type:"mc", q:"Earth spin mph equator?", options:["500","1000","1500","2000"], correct:1},
    {type:"mc", q:"Elements on periodic table?", options:["92","108","118","124"], correct:2},
    {type:"mc", q:"Universal donor?", options:["AB+","A-","O-","B+"], correct:2},
    {type:"mc", q:"Moons of Neptune?", options:["8","14","27","63"], correct:1},
    {type:"mc", q:"Disease eradicated in 1980?", options:["Polio","Measles","Smallpox","Malaria"], correct:2},
    {type:"mc", q:"First American woman in space?", options:["Tereshkova","Jemison","Sally Ride","Resnik"], correct:2},
    {type:"mc", q:"Pounds in US ton?", options:["1000","2000","2204","2240"], correct:1},
    {type:"mc", q:"Largest bone?", options:["Tibia","Femur","Humerus","Spine"], correct:1},
    {type:"mc", q:"Planets in solar system?", options:["7","8","9","10"], correct:1},
    {type:"mc", q:"Colours in a rainbow?", options:["6","7","8","Indefinite"], correct:1},
    {type:"mc", q:"Astronomer in Bohemian Rhapsody?", options:["Copernicus","Kepler","Galileo","Newton"], correct:2},
    {type:"mc", q:"Which one doesn’t belong on a burger?", options:["Lettuce","Tomato","Onion","Pickles"], correct:3},
    {type:"mc", q:"Which one is not used for writing?", options:["Pencil","Pen","Keyboard","Spoon"], correct:3},
    {type:"mc", q:"Which one is not a mammal?", options:["Dolphin","Whale","Shark","Human"], correct:2},
    {type:"mc", q:"Which one is not a planet?", options:["Mars","Venus","Pluto","Sirius"], correct:3},
    {type:"mc", q:"Which one is not a fruit?", options:["Apple","Banana","Carrot","Grape"], correct:2},
    {type:"mc", q:"Which one cannot fly?", options:["Eagle","Bat","Penguin","Parrot"], correct:2}
  ];

  const starQuestions = [
    {id:"s1", text:"What surprised you most during your time in the Algarve?", tag:"experienced"},
    {id:"s2", text:"What everyday thing in the Algarve felt more annoying than it should’ve?", tag:"experienced"},
    {id:"s3", text:"What simple thing from home would’ve made your stay in the Algarve easier?", tag:"all"},
    {id:"s4", text:"What useful service did you wish existed in the Algarve?", tag:"experienced"},
    {id:"s5", text:"What in the Algarve turned out more confusing than expected?", tag:"experienced"},
    {id:"s6", text:"What was unexpectedly hard to find in the Algarve?", tag:"experienced"},
    {id:"s7", text:"Which daily chore in the Algarve would you happily pay to avoid?", tag:"all"},
    {id:"s8", text:"What in the Algarve made you think: ‘This should be quicker’?", tag:"experienced"},
    {id:"s9", text:"What in the Algarve felt outdated or slow?", tag:"experienced"},
    {id:"s10", text:"What did you miss most from home while in the Algarve?", tag:"all"},
    {id:"s11", text:"What activity did you expect to find in the Algarve but didn’t?", tag:"experienced"},
    {id:"s12", text:"When in the Algarve did you think: ‘This could work better’?", tag:"experienced"},
    {id:"s13", text:"What in the Algarve took too long to figure out?", tag:"experienced"},
    {id:"s14", text:"Which local service in the Algarve disappointed you?", tag:"experienced"},
    {id:"s15", text:"What would’ve made your stay in the Algarve more comfortable?", tag:"experienced"},
    {id:"s16", text:"What felt overpriced in the Algarve?", tag:"experienced"},
    {id:"s17", text:"What from home would’ve made your Algarve stay smoother?", tag:"all"}
  ];

  let answers = {}, sequence = [], pointer = 0, timer = null, timeLeft = 30;

  // PRISONER'S DILEMMA GAME STATE
  const pdGameId = 'prisonersDilemma';
  const pdDefaultDuration = 60;
  let pdState = {
    userScore: 0,
    aiScore: 0,
    timeLeft: pdDefaultDuration,
    timerId: null,
    active: false,
    lastUserMove: 'cooperate',
    history: [],
    ended: false
  };

  const app = document.getElementById('app');

  function esc(t){ return t.replace(/[&<>"']/g, r=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[r])); }
  function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]); }

  // PD helpers
  function resetPdState(saved = null) {
    stopPdTimer();
    pdState = {
      userScore: saved?.userScore || 0,
      aiScore: saved?.aiScore || 0,
      timeLeft: pdDefaultDuration,
      timerId: null,
      active: false,
      lastUserMove: 'cooperate',
      history: saved?.history ? [...saved.history] : [],
      ended: saved?.ended || false
    };
  }

  function stopPdTimer() {
    if (pdState.timerId) {
      clearInterval(pdState.timerId);
      pdState.timerId = null;
    }
  }

  function pdFormatTime(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function savePdAnswer(id, finalized = false) {
    answers[id] = {
      userScore: pdState.userScore,
      aiScore: pdState.aiScore,
      history: pdState.history,
      timePlayed: pdDefaultDuration - pdState.timeLeft,
      ended: finalized
    };
    autoSave();
  }

  function pdOutcome(userMove, aiMove) {
    if (userMove === 'attack' && aiMove === 'attack') return [1, 1];
    if (userMove === 'attack' && aiMove === 'cooperate') return [5, 0];
    if (userMove === 'cooperate' && aiMove === 'attack') return [0, 5];
    return [3, 3];
  }

  function renderMeta() {
    app.innerHTML = `
      <div class="container flex flex-col justify-center items-center h-full px-6">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl p-8 w-full max-w-md">
          <h1 class="text-4xl font-black text-center mb-10">How Smart are You?</h1>
          <div class="space-y-8">
            <div>
              <label class="block text-xl font-semibold mb-3">Staying in Algarve?</label>
              <select id="stay" class="w-full p-5 rounded-2xl border-[3px] border-slate-300 dark:border-slate-700 dark:bg-slate-800 text-lg">
                <option value="leaving">Leaving soon</option>
                <option value="few">Few more days</option>
                <option value="just">Just arrived</option>
                <option value="not">Not here</option>
              </select>
            </div>

            <div>
              <label class="block text-xl font-semibold mb-3">How Bored are you? (1-10)</label>
              <input id="mins" type="range" min="1" max="10" value="5" class="w-full">
              <div class="text-center text-5xl font-bold mt-4"><span id="minsVal">5</span></div>
            </div>

            <div class="space-y-3">
              <button id="start" class="w-full py-6 bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-bold rounded-3xl shadow-xl">Start</button>
            </div>
          </div>
        </div>
      </div>`;

    document.getElementById('mins').oninput = e => {
      document.getElementById('minsVal').textContent = e.target.value;
      autoSave();
    };

    document.getElementById('stay').onchange = () => autoSave();
    document.getElementById('start').onclick = startSurvey;
  }

  function startSurvey() {
    const mins = +document.getElementById('mins').value;
    const stay = document.getElementById('stay').value;

    const maxF = mins < 4 ? 5 : mins < 7 ? 10 : 16;
    const maxS = mins < 4 ? 2 : mins < 7 ? 5 : 8;

    const stars = shuffle(starQuestions.filter(q => q.tag === 'all' || (q.tag === 'experienced' && stay !== 'just'))).slice(0, maxS);

    const facts = shuffle([
      ...trueFalseQuestions.map(f => ({...f,isTF:true})),
      ...mcQuestions.map(f => ({...f,isTF:false}))
    ]).slice(0, maxF);

    sequence = [];
    let streak = 0, si = 0;

    facts.forEach(f => {
      sequence.push({type:'fact', q:f.q, options:f.options||null, correct:f.correct, isTF:f.isTF});
      streak++;
      if ((streak >= 2 && Math.random()<0.7) || streak >= 3) {
        if (si < stars.length) {
          sequence.push({type:'star', id:stars[si].id, text:stars[si].text});
          si++;
          streak = 0;
        }
      }
    });

    while (si < stars.length) {
      sequence.push({type:'star', id:stars[si].id, text:stars[si].text});
      si++;
    }

    // insert mini-game randomly
    if (sequence.length > 1) {
      const insertAt = Math.floor(Math.random() * (sequence.length - 1)) + 1;
      sequence.splice(insertAt, 0, { type: 'game', id: pdGameId });
    }

    pointer = 0;
    answers = {};
    renderQuestion();
    autoSave();
  }

  function startTimer() {
    timeLeft = 30;
    updateTimer();
    clearInterval(timer);
    timer = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        clearInterval(timer);
        answers[sequence[pointer].q] = {answer:null, timedOut:true};
        autoSave();
        next();
      }
    }, 1000);
  }

  function updateTimer() {
    const ring = document.getElementById('ring');
    const num = document.getElementById('time');
    if (!ring) return;
    const c = 1356;
    ring.style.strokeDashoffset = c - (timeLeft/30)*c;
    num.textContent = timeLeft;
    ring.style.stroke = timeLeft > 10 ? '#10b981' : timeLeft > 5 ? '#f59e0b' : '#ef4444';
  }

  function renderQuestion() {
    stopPdTimer();
    const q = sequence[pointer];
    const progress = Math.round(((pointer + 1) / sequence.length) * 100);

    app.innerHTML = `
      <div class="container flex flex-col h-full">
        <div class="flex justify-between items-center py-4 px-6">
          <button id="back" class="text-3xl">←</button>
          <div class="text-lg font-bold">${pointer+1}/${sequence.length}</div>
          <div class="w-32 h-2 bg-gray-300 dark:bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full bg-indigo-600 transition-all duration-300" style="width:${progress}%"></div>
          </div>
        </div>

        <div class="flex-1 flex flex-col justify-center px-6">
          ${q.type === 'fact' ? `
            <div class="text-center mb-8">
              <svg width="90" height="90" viewBox="0 0 480 480" class="mx-auto">
                <circle cx="240" cy="240" r="216" stroke="#e2e8f0" stroke-width="36" fill="none" class="dark:stroke-[#334155]"/>
                <circle id="ring" cx="240" cy="240" r="216" stroke="#10b981" stroke-width="36" fill="none" stroke-dasharray="1356" style="stroke-dashoffset:1356" class="timer-ring"/>
                <text id="time" x="240" y="280" font-size="120" text-anchor="middle" font-weight="bold" fill="currentColor">30</text>
              </svg>
              <h2 class="text-2xl font-black leading-tight mt-6">${esc(q.q)}</h2>
            </div>

            <div class="space-y-3 mt-auto">
              ${q.isTF ? `
                <button class="true w-full py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-3xl shadow-xl">TRUE</button>
                <button class="false w-full py-6 bg-gradient-to-r from-red-500 to-rose-600 text-white text-2xl font-bold rounded-3xl shadow-xl">FALSE</button>
              ` : q.options.map((o,i) => `
                <button data-i="${i}" class="option w-full py-5 text-xl font-medium bg-white dark:bg-slate-800 border-[3px] border-gray-300 dark:border-slate-700 rounded-2xl hover:border-indigo-500 dark:hover:border-indigo-400 transition">${esc(o)}</button>
              `).join('')}
            </div>
          ` : q.type === 'game' ? `
            <div class="flex-1 flex items-center justify-center px-2">
              <div class="pd-game-outer">
                <div class="pd-game-shell">
                  <div class="pd-hud">
                    <div class="pd-hud-label">PRISONER&nbsp;FIELD</div>
                    <div class="pd-hud-timer" id="pdTimer">01:00</div>
                    <div class="pd-hud-scorebox">
                      <div class="pd-hud-chip">
                        <span>YOU</span>
                        <span class="pd-score-value" id="pdUserScore">0</span>
                      </div>
                      <div class="pd-hud-chip pd-hud-chip-ai">
                        <span>AI</span>
                        <span class="pd-score-value" id="pdAiScore">0</span>
                      </div>
                    </div>
                  </div>

                  <div class="pd-field">
                    <div class="pd-cloud" style="left:-40px;"></div>
                    <div class="pd-cloud cloud2" style="left:40px;"></div>
                    <div class="pd-cloud cloud3" style="left:140px;"></div>

                    <div class="pd-field-row">
                      <!-- Player -->
                      <div>
                        <div class="pd-character">
                          <div class="pd-face">
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel-eye"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel-eye"></div>
                            <div class="pd-pixel"></div>

                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>

                            <div class="pd-pixel"></div>
                            <div class="pd-pixel-mouth"></div>
                            <div class="pd-pixel-mouth"></div>
                            <div class="pd-pixel-mouth"></div>
                            <div class="pd-pixel"></div>

                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                          </div>
                        </div>
                        <div class="pd-label-under">YOU</div>
                      </div>

                      <div class="pd-middle">
                        CHOOSE FAST
                        <span>Attack = risky · Cooperate = friendly</span>
                      </div>

                      <!-- AI -->
                      <div>
                        <div class="pd-character pd-character-ai">
                          <div class="pd-face">
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel-eye"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel-eye"></div>
                            <div class="pd-pixel"></div>

                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>

                            <div class="pd-pixel-mouth"></div>
                            <div class="pd-pixel-mouth"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel-mouth"></div>
                            <div class="pd-pixel-mouth"></div>

                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                            <div class="pd-pixel"></div>
                          </div>
                        </div>
                        <div class="pd-label-under">AI</div>
                      </div>
                    </div>
                  </div>

                  <div class="pd-controls">
                    <button id="pdAttack" class="pd-btn">ATTACK</button>
                    <button id="pdCooperate" class="pd-btn pd-btn-primary">COOPERATE</button>
                    <button id="pdStart" class="pd-btn pd-btn-small">START</button>
                  </div>

                  <div class="pd-message-box">
                    <div id="pdMessage" class="pd-msg pd-msg-info">
                      Press START, then tap ATTACK or COOPERATE to score points in 60 seconds.
                    </div>
                    <div class="pd-history" id="pdHistory"></div>
                  </div>

                  <div class="pd-continue-wrap">
                    <button id="pdContinue" class="pd-continue-btn">CONTINUE</button>
                  </div>
                </div>
              </div>
            </div>
          ` : `
            <div class="flex-1 flex flex-col justify-center">
              <h2 class="text-2xl font-black leading-tight mb-6">${esc(q.text)}</h2>
              <textarea id="txt" class="flex-1 min-h-0 p-5 text-lg rounded-2xl border-[3px] border-gray-300 dark:border-slate-700 dark:bg-slate-800 focus:border-indigo-500 outline-none resize-none" placeholder="Your answer...">${answers[q.id]?.answer||''}</textarea>
              <button id="nextStar" class="mt-6 w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold rounded-2xl shadow-xl">Next</button>
            </div>
          `}
        </div>
      </div>`;

    const ring = document.getElementById('ring');
    if (ring) ring.style.strokeDashoffset = 1356;

    if (q.type === 'fact') startTimer();

    if (q.type === 'fact' && q.isTF) {
      document.querySelector('.true').onclick = () => choose(true);
      document.querySelector('.false').onclick = () => choose(false);
    }

    if (q.type === 'fact' && !q.isTF) {
      document.querySelectorAll('.option').forEach(b => {
        b.onclick = () => {
          document.querySelectorAll('.option').forEach(x => x.classList.remove('border-indigo-500','bg-indigo-50','dark:bg-indigo-900'));
          b.classList.add('border-indigo-500','bg-indigo-50','dark:bg-indigo-900');
          choose(+b.dataset.i);
        };
      });
    }

    if (q.type === 'game') {
      const saved = answers[q.id];
      resetPdState(saved);

      const timerEl = document.getElementById('pdTimer');
      const userScoreEl = document.getElementById('pdUserScore');
      const aiScoreEl = document.getElementById('pdAiScore');
      const attackBtn = document.getElementById('pdAttack');
      const coopBtn = document.getElementById('pdCooperate');
      const startBtn = document.getElementById('pdStart');
      const msgEl = document.getElementById('pdMessage');
      const historyEl = document.getElementById('pdHistory');
      const continueBtn = document.getElementById('pdContinue');

      function setPdMessage(text, type = 'info') {
        msgEl.textContent = text;
        msgEl.className = 'pd-msg';
        msgEl.classList.add(
          type === 'good' ? 'pd-msg-good' :
          type === 'bad' ? 'pd-msg-bad' :
          type === 'warn' ? 'pd-msg-warn' :
          'pd-msg-info'
        );
      }

      function renderPdHistory() {
        historyEl.innerHTML = pdState.history.map(h =>
          `<div class="pd-history-entry"><span>${h.user}</span><span>${h.ai}</span></div>`
        ).join('');
      }

      function updatePdUi() {
        timerEl.textContent = pdFormatTime(pdState.timeLeft);
        userScoreEl.textContent = pdState.userScore;
        aiScoreEl.textContent = pdState.aiScore;
        renderPdHistory();
      }

      function pdEndGame() {
        stopPdTimer();
        pdState.active = false;
        pdState.ended = true;
        attackBtn.disabled = true;
        coopBtn.disabled = true;
        const verdict =
          pdState.userScore > pdState.aiScore ? 'good' :
          pdState.userScore < pdState.aiScore ? 'bad' : 'info';

        if (pdState.userScore === pdState.aiScore) {
          setPdMessage(`Time up! Tie: ${pdState.userScore} - ${pdState.aiScore}.`, verdict);
        } else if (pdState.userScore > pdState.aiScore) {
          setPdMessage(`Time up! You win ${pdState.userScore} vs ${pdState.aiScore}.`, verdict);
        } else {
          setPdMessage(`Time up! AI wins ${pdState.aiScore} vs ${pdState.userScore}.`, verdict);
        }

        continueBtn.disabled = false;
        savePdAnswer(q.id, true);
      }

      function pdPlayRound(userMove) {
        if (!pdState.active || pdState.timeLeft <= 0) return;
        const aiMove = pdState.lastUserMove;
        const [userPts, aiPts] = pdOutcome(userMove, aiMove);

        pdState.userScore += userPts;
        pdState.aiScore += aiPts;
        pdState.lastUserMove = userMove;

        pdState.history.unshift({
          user: `${userMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (+${userPts})`,
          ai: `${aiMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (+${aiPts})`
        });

        setPdMessage(
          `You: ${userMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (${userPts}) · AI: ${aiMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (${aiPts})`,
          userPts >= aiPts ? 'good' : 'bad'
        );

        savePdAnswer(q.id, false);
        updatePdUi();
      }

      function startPdGame() {
        resetPdState();
        pdState.active = true;
        attackBtn.disabled = false;
        coopBtn.disabled = false;
        continueBtn.disabled = false;
        setPdMessage('Go! Make the best score in 60 seconds.', 'info');
        updatePdUi();
        stopPdTimer();
        pdState.timerId = setInterval(() => {
          pdState.timeLeft--;
          updatePdUi();
          if (pdState.timeLeft <= 0) pdEndGame();
        }, 1000);
      }

      attackBtn.onclick = () => pdPlayRound('attack');
      coopBtn.onclick = () => pdPlayRound('cooperate');
      startBtn.onclick = startPdGame;
      continueBtn.onclick = () => {
        pdState.ended = true;
        stopPdTimer();
        savePdAnswer(q.id, true);
        next();
      };

      // initial UI
      attackBtn.disabled = true;
      coopBtn.disabled = true;
      continueBtn.disabled = false;
      if (saved?.ended) {
        setPdMessage('Game finished. Hit CONTINUE when ready.', 'info');
      }
      updatePdUi();
    }

    if (q.type === 'star') {
      const textarea = document.getElementById('txt');
      textarea.addEventListener('input', () => {
        answers[q.id] = {answer: textarea.value.trim()};
        autoSave();
      });

      document.getElementById('nextStar').onclick = () => {
        answers[q.id] = {answer: textarea.value.trim()};
        autoSave();
        next();
      };
    }

    document.getElementById('back').onclick = () => {
      if (pointer > 0) {
        clearInterval(timer);
        pointer--;
        renderQuestion();
      }
    };
  }

  function choose(val) {
    clearInterval(timer);
    answers[sequence[pointer].q] = {answer: val};
    autoSave();
    next();
  }

  function next() {
    pointer++;
    autoSave();
    if (pointer >= sequence.length) finish();
    else renderQuestion();
  }

  let smart = 0;

  function finish() {
    clearInterval(timer);

    const facts = sequence.filter(x => x.type === 'fact');

    let correct = 0;
    let recap = '';

    facts.forEach(f => {
      const a = answers[f.q] || {answer:null};
      if (a.answer === f.correct) correct++;

      const user = a.answer === null ? 'Timed out' : f.isTF ? (a.answer ? 'True' : 'False') : f.options[a.answer];
      const corr = f.isTF ? (f.correct ? 'True' : 'False') : f.options[f.correct];

      recap += `
        <div class="p-4 bg-white/80 dark:bg-slate-800/80 rounded-xl mb-3">
          <strong class="block mb-1">${esc(f.q)}</strong>
          <div>You: ${user} | Correct: ${corr}</div>
        </div>`;
    });

    smart = facts.length ? Math.round(correct / facts.length * 100) : 0;
    autoSave(true);

    app.innerHTML = `
      <div class="container flex flex-col h-full px-6 pt-8 overflow-y-auto">
        <h1 class="text-5xl font-black text-center mb-8">Results</h1>

        <div class="grid grid-cols-1 gap-5 mb-8">
          <div class="bg-indigo-100 dark:bg-indigo-900 p-6 rounded-3xl text-center">
            <div class="text-xl font-bold">Smart</div>
            <div class="text-6xl font-black">${smart}</div>
          </div>
        </div>

        <div class="space-y-3 flex-1 overflow-y-auto">${recap}</div>

        <button onclick="location.reload()" class="w-full py-5 bg-indigo-600 text-white text-xl font-bold rounded-2xl shadow-xl mt-6">Retake Survey</button>
      </div>`;
  }

  renderMeta();
})();
</script>

<script>
function setStatus(text) {
  const el = document.getElementById('status');
  if (el) el.textContent = text;
}
</script>

</body>
</html>
