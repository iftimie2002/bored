<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>How Smart are You?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .container { padding: env(safe-area-inset-top, 1rem) env(safe-area-inset-right, 0.5rem) max( env(safe-area-inset-bottom, 1.5rem), 2rem ) env(safe-area-inset-left, 0.5rem); }
    .timer-ring { transition: stroke-dashoffset 0.35s ease; }
    /* Retro mini-game styles */
    @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

    .pd-game-outer {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border-radius: 18px;
      padding: 8px;
      background: #111827;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      image-rendering: pixelated;
      font-family: "Press Start 2P", system-ui, sans-serif;
    }

    .pd-game-shell {
      border-radius: 14px;
      padding: 6px;
      background: #27272f;
      border: 3px solid #4b5563;
      position: relative;
      overflow: hidden;
    }

    .pd-game-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: repeating-linear-gradient(
        135deg,
        rgba(255,255,255,0.04) 0,
        rgba(255,255,255,0.04) 2px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
    }

    .pd-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 8px;
      color: #e5e7eb;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .pd-hud-label {
      background: #000;
      padding: 4px 6px;
      border-radius: 6px;
      border: 2px solid #6b7280;
      box-shadow: 0 0 0 2px #000;
    }

    .pd-hud-timer {
      background: #0f172a;
      padding: 4px 8px;
      border-radius: 999px;
      border: 2px solid #facc15;
      color: #facc15;
      font-size: 9px;
      box-shadow: 0 0 0 2px #000;
      min-width: 58px;
      text-align: center;
    }

    .pd-hud-scorebox {
      display: flex;
      gap: 4px;
      font-size: 7px;
    }

    .pd-hud-chip {
      background: #000;
      padding: 3px 5px;
      border-radius: 6px;
      border: 2px solid #4ade80;
      box-shadow: 0 0 0 2px #000;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pd-hud-chip span {
      white-space: nowrap;
    }

    .pd-hud-chip-ai {
      border-color: #f97373;
    }

    .pd-score-value {
      background: #111;
      padding: 3px 4px;
      border-radius: 4px;
      min-width: 18px;
      text-align: center;
    }

    .pd-field {
      position: relative;
      margin-top: 4px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid #374151;
      box-shadow: 0 0 0 2px #111827;
      background:
        linear-gradient(#60a5fa 0%, #60a5fa 45%, #22c55e 45%, #16a34a 100%);
      padding: 24px 10px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pd-cloud {
      position: absolute;
      top: 6px;
      width: 46px;
      height: 18px;
      background: #e5f2ff;
      border-radius: 8px;
      box-shadow:
        10px 0 0 #e5f2ff,
        -10px 0 0 #e5f2ff,
        0 6px 0 #e5f2ff;
      filter: drop-shadow(0 0 2px rgba(15,23,42,0.5));
      animation: cloud-drift 12s linear infinite;
    }

    .pd-cloud.cloud2 {
      top: 14px;
      animation-duration: 18s;
      opacity: 0.8;
    }

    .pd-cloud.cloud3 {
      top: 2px;
      animation-duration: 22s;
      opacity: 0.65;
    }

    @keyframes cloud-drift {
      0%   { transform: translateX(-60px); }
      100% { transform: translateX(260px); }
    }

    .pd-field-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 6px;
      z-index: 1;
    }

    .pd-character {
      width: 40px;
      height: 40px;
      background: #facc15;
      border-radius: 4px;
      box-shadow:
        0 0 0 3px #000,
        0 4px 0 #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: char-bob 0.7s ease-in-out infinite alternate;
    }

    .pd-character-ai {
      background: #fb7185;
    }

    @keyframes char-bob {
      from { transform: translateY(1px); }
      to   { transform: translateY(-3px); }
    }

    .pd-face {
      width: 26px;
      height: 18px;
      background: #fde68a;
      border-radius: 2px;
      box-shadow: 0 0 0 2px #000;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 1px;
      padding: 2px;
    }

    .pd-pixel {
      width: 100%;
      height: 100%;
      background: transparent;
    }

    .pd-pixel-eye {
      background: #000;
    }

    .pd-pixel-mouth {
      background: #000;
    }

    .pd-label-under {
      margin-top: 4px;
      text-align: center;
      font-size: 7px;
      color: #111827;
      text-shadow: 0 1px 0 #f9fafb;
    }

    .pd-middle {
      text-align: center;
      font-size: 8px;
      color: #0f172a;
      padding: 4px 6px;
      background: rgba(248, 250, 252, 0.9);
      border-radius: 6px;
      box-shadow: 0 0 0 2px #0f172a;
      margin: 0 8px;
    }

    .pd-middle span {
      display: block;
      margin-top: 2px;
      font-size: 7px;
      color: #4b5563;
    }

    .pd-controls {
      display: flex;
      gap: 8px;
      margin: 4px 4px 2px;
      z-index: 1;
    }

    .pd-btn {
      flex: 1;
      border: 0;
      outline: none;
      cursor: pointer;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      padding: 9px 4px;
      background: #e5e7eb;
      color: #111827;
      border-radius: 6px;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s ease;
    }

    .pd-btn-primary {
      background: #4f46e5;
      color: #f9fafb;
    }

    .pd-btn-small {
      flex: 0 0 auto;
      font-size: 8px;
      padding: 7px 6px;
      background: #fecaca;
    }

    .pd-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
      filter: brightness(0.85);
    }

    .pd-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.4);
    }

    .pd-message-box {
      margin: 4px 4px 2px;
      padding: 6px 6px 4px;
      border-radius: 8px;
      background: #020617;
      box-shadow: 0 0 0 2px #000;
      font-size: 8px;
      color: #e5e7eb;
      z-index: 1;
    }

    .pd-msg {
      min-height: 1.6em;
      margin-bottom: 3px;
    }

    .pd-msg-info { color: #e5e7eb; }
    .pd-msg-good { color: #4ade80; }
    .pd-msg-bad  { color: #f97373; }
    .pd-msg-warn { color: #fbbf24; }

    .pd-history {
      max-height: 82px;
      overflow-y: auto;
      padding: 4px;
      background: #020617;
      border-radius: 6px;
      box-shadow: inset 0 0 0 1px #111827;
      font-size: 7px;
    }

    .pd-history-entry {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1px;
      color: #9ca3af;
    }

    .pd-history-entry span {
      white-space: nowrap;
    }

    .pd-continue-wrap {
      margin-top: 5px;
      padding: 0 4px 2px;
    }

    .pd-continue-btn {
      width: 100%;
      border-radius: 8px;
      border: 0;
      outline: 0;
      padding: 9px 4px;
      background: #22c55e;
      color: #052e16;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease;
    }

    .pd-continue-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
    }

    /* Snake mini-game */
    .sn-game-outer {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border-radius: 18px;
      padding: 8px;
      background: #111827;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      image-rendering: pixelated;
      font-family: "Press Start 2P", system-ui, sans-serif;
    }

    .sn-game-shell {
      border-radius: 14px;
      padding: 6px;
      background: #27272f;
      border: 3px solid #4b5563;
      position: relative;
      overflow: hidden;
    }

    .sn-game-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: repeating-linear-gradient(
        135deg,
        rgba(255,255,255,0.04) 0,
        rgba(255,255,255,0.04) 2px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
    }

    .sn-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 8px;
      color: #e5e7eb;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .sn-hud-label {
      background: #000;
      padding: 4px 6px;
      border-radius: 6px;
      border: 2px solid #6b7280;
      box-shadow: 0 0 0 2px #000;
    }

    .sn-hud-middle {
      font-size: 8px;
      color: #e5e7eb;
      opacity: 0.9;
      text-align: center;
    }

    .sn-hud-scorebox {
      display: flex;
      gap: 4px;
      font-size: 7px;
    }

    .sn-hud-chip {
      background: #000;
      padding: 3px 5px;
      border-radius: 6px;
      border: 2px solid #4ade80;
      box-shadow: 0 0 0 2px #000;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sn-score-value {
      background: #111;
      padding: 3px 4px;
      border-radius: 4px;
      min-width: 22px;
      text-align: center;
    }

    .sn-field {
      position: relative;
      margin-top: 4px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid #374151;
      box-shadow: 0 0 0 2px #111827;
      background:
        linear-gradient(#60a5fa 0%, #60a5fa 40%, #22c55e 40%, #15803d 100%);
      padding: 18px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sn-cloud {
      position: absolute;
      top: 6px;
      width: 46px;
      height: 18px;
      background: #e5f2ff;
      border-radius: 8px;
      box-shadow:
        10px 0 0 #e5f2ff,
        -10px 0 0 #e5f2ff,
        0 6px 0 #e5f2ff;
      filter: drop-shadow(0 0 2px rgba(15,23,42,0.5));
      animation: cloud-drift 12s linear infinite;
    }

    .sn-cloud.c2 {
      top: 16px;
      animation-duration: 20s;
      opacity: 0.8;
    }

    .sn-cloud.c3 {
      top: 2px;
      animation-duration: 24s;
      opacity: 0.65;
    }

    .sn-field-row {
      display: flex;
      justify-content: center;
      z-index: 1;
    }

    .sn-canvas-wrap {
      padding: 6px;
      background: #064e3b;
      border-radius: 10px;
      box-shadow:
        0 0 0 2px #000,
        0 4px 0 #000;
    }

    .sn-canvas {
      display: block;
      background: #022c22;
      box-shadow: inset 0 0 0 2px #111827;
      image-rendering: pixelated;
    }

    .sn-controls {
      display: flex;
      gap: 8px;
      margin: 6px 4px 4px;
      z-index: 1;
    }

    .sn-btn {
      flex: 1;
      border: 0;
      outline: none;
      cursor: pointer;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      padding: 9px 4px;
      background: #e5e7eb;
      color: #111827;
      border-radius: 6px;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s ease;
    }

    .sn-btn-primary {
      background: #4f46e5;
      color: #f9fafb;
    }

    .sn-btn-small {
      flex: 0 0 auto;
      font-size: 8px;
      padding: 7px 6px;
      background: #fecaca;
    }

    .sn-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
      filter: brightness(0.85);
    }

    .sn-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.4);
    }

    .sn-message-box {
      margin: 4px 4px 2px;
      padding: 6px 6px 4px;
      border-radius: 8px;
      background: #020617;
      box-shadow: 0 0 0 2px #000;
      font-size: 8px;
      color: #e5e7eb;
      z-index: 1;
      min-height: 1.6em;
    }

    .sn-msg-good { color: #4ade80; }
    .sn-msg-bad  { color: #f97373; }
    .sn-msg-warn { color: #fbbf24; }

    /* MOBILE ARROW KEYS */
    .sn-mobile-arrows {
      margin: 6px 4px 4px;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .sn-arrow-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      width: 100%;
    }

    .sn-arrow-btn {
      border: 0;
      outline: none;
      cursor: pointer;
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 12px;
      padding: 10px 14px;
      background: #e5e7eb;
      color: #111827;
      border-radius: 8px;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      min-width: 52px;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s ease;
    }

    .sn-arrow-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
      filter: brightness(0.85);
    }

    .sn-arrow-btn-empty {
      opacity: 0;
      pointer-events: none;
      box-shadow: none;
    }

    .sn-continue-wrap {
      margin: 6px 4px 4px;
    }

    .sn-continue-btn {
      width: 100%;
      border-radius: 8px;
      border: 0;
      outline: 0;
      padding: 9px 4px;
      background: #22c55e;
      color: #052e16;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease;
    }

    .sn-continue-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
    }

    /* BLOCK DUDE MINI GAME */
    .bd-game-outer {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border-radius: 18px;
      padding: 8px;
      background: #111827;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      image-rendering: pixelated;
      font-family: "Press Start 2P", system-ui, sans-serif;
    }

    .bd-game-shell {
      border-radius: 14px;
      padding: 6px;
      background: #27272f;
      border: 3px solid #4b5563;
      position: relative;
      overflow: hidden;
    }

    .bd-game-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: repeating-linear-gradient(
        135deg,
        rgba(255,255,255,0.04) 0,
        rgba(255,255,255,0.04) 2px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
    }

    .bd-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 8px;
      color: #e5e7eb;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .bd-hud-label {
      background: #000;
      padding: 4px 6px;
      border-radius: 6px;
      border: 2px solid #6b7280;
      box-shadow: 0 0 0 2px #000;
    }

    .bd-hud-middle {
      font-size: 8px;
      color: #e5e7eb;
      opacity: 0.9;
      text-align: center;
    }

    .bd-hud-right {
      font-size: 7px;
      text-align: right;
      color: #9ca3af;
    }

    .bd-field {
      position: relative;
      margin-top: 4px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid #374151;
      box-shadow: 0 0 0 2px #111827;
      background:
        linear-gradient(#60a5fa 0%, #60a5fa 40%, #22c55e 40%, #15803d 100%);
      padding: 16px 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bd-cloud {
      position: absolute;
      top: 6px;
      width: 46px;
      height: 18px;
      background: #e5f2ff;
      border-radius: 8px;
      box-shadow:
        10px 0 0 #e5f2ff,
        -10px 0 0 #e5f2ff,
        0 6px 0 #e5f2ff;
      filter: drop-shadow(0 0 2px rgba(15,23,42,0.5));
      animation: bd-cloud-drift 16s linear infinite;
    }

    .bd-cloud.c2 {
      top: 16px;
      animation-duration: 22s;
      opacity: 0.8;
    }

    .bd-cloud.c3 {
      top: 2px;
      animation-duration: 26s;
      opacity: 0.65;
    }

    @keyframes bd-cloud-drift {
      0%   { transform: translateX(-60px); }
      100% { transform: translateX(260px); }
    }

    .bd-field-row {
      display: flex;
      justify-content: center;
      z-index: 1;
    }

    .bd-canvas-wrap {
      padding: 6px;
      background: #064e3b;
      border-radius: 10px;
      box-shadow:
        0 0 0 2px #000,
        0 4px 0 #000;
    }

    .bd-canvas {
      display: block;
      background: #022c22;
      box-shadow: inset 0 0 0 2px #111827;
      image-rendering: pixelated;
    }

    .bd-controls {
      display: flex;
      gap: 8px;
      margin: 6px 4px 4px;
      z-index: 1;
    }

    .bd-btn {
      flex: 1;
      border: 0;
      outline: none;
      cursor: pointer;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      padding: 9px 4px;
      background: #e5e7eb;
      color: #111827;
      border-radius: 6px;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s ease;
    }

    .bd-btn-primary {
      background: #4f46e5;
      color: #f9fafb;
    }

    .bd-btn-small {
      flex: 0 0 auto;
      font-size: 8px;
      padding: 7px 6px;
      background: #fecaca;
    }

    .bd-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
      filter: brightness(0.85);
    }

    .bd-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.4);
    }

    .bd-message-box {
      margin: 4px 4px 2px;
      padding: 6px 6px 4px;
      border-radius: 8px;
      background: #020617;
      box-shadow: 0 0 0 2px #000;
      font-size: 8px;
      color: #e5e7eb;
      z-index: 1;
      min-height: 1.6em;
    }

    .bd-msg-good { color: #4ade80; }
    .bd-msg-bad  { color: #f97373; }
    .bd-msg-warn { color: #fbbf24; }

    .bd-mobile-arrows {
      margin: 6px 4px 4px;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .bd-arrow-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      width: 100%;
    }

    .bd-arrow-btn {
      border: 0;
      outline: none;
      cursor: pointer;
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 12px;
      padding: 10px 14px;
      background: #e5e7eb;
      color: #111827;
      border-radius: 8px;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      min-width: 52px;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s ease;
    }

    .bd-arrow-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
      filter: brightness(0.85);
    }

    .bd-arrow-btn-empty {
      opacity: 0;
      pointer-events: none;
      box-shadow: none;
    }

    .bd-continue-wrap {
      margin: 6px 4px 4px;
    }

    .bd-continue-btn {
      width: 100%;
      border-radius: 8px;
      border: 0;
      outline: 0;
      padding: 9px 4px;
      background: #22c55e;
      color: #052e16;
      font-size: 9px;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
      box-shadow:
        0 0 0 2px #000,
        0 3px 0 #000;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease;
    }

    .bd-continue-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 0 0 2px #000,
        0 0 0 #000;
    }

    @media (max-width: 400px) {
      .bd-hud {
        font-size: 7px;
      }
      .bd-btn {
        font-size: 8px;
        padding: 8px 4px;
      }
      .bd-arrow-btn {
        font-size: 10px;
        min-width: 44px;
        padding: 8px 10px;
      }
      .bd-continue-btn {
        font-size: 8px;
      }
    }

    @media (max-width: 400px) {
      .sn-hud {
        font-size: 7px;
      }
      .sn-btn {
        font-size: 8px;
      }
      .sn-arrow-btn {
        font-size: 10px;
        min-width: 44px;
        padding: 8px 10px;
      }
      .sn-continue-btn {
        font-size: 8px;
      }
    }

    @media (max-width: 400px) {
      .pd-hud {
        font-size: 7px;
      }
      .pd-hud-timer {
        font-size: 8px;
      }
      .pd-btn {
        font-size: 8px;
      }
      .pd-continue-btn {
        font-size: 8px;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.8.6/jsrsasign-all-min.js"></script>

</head>

<body class="h-full text-slate-900 dark:text-slate-100 transition-colors duration-300 bg-gradient-to-br from-indigo-50 via-white to-pink-50 dark:from-slate-900 dark:via-slate-950 dark:to-purple-950">

  <div id="app" class="h-full flex flex-col"></div>

  <!-- ADDED STATUS BAR -->
  <div id="status" style="text-align:center; margin:8px; font-weight:bold;"></div>






  
<script>
(function(){
  if (window.matchMedia('(prefers-color-scheme: dark)').matches)
    document.documentElement.classList.add('dark');

  // FECHAR BEM O addEventListener
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    document.documentElement.classList.toggle('dark', e.matches);
  });

  // IP do cliente (async)
  let clientIp = null;

  function loadClientIp() {
    try {
      fetch('https://api.ipify.org?format=json')
        .then(r => r.json())
        .then(d => {
          clientIp = d.ip;
          console.log('clientIp =', clientIp);
        })
        .catch(err => {
          console.warn('IP lookup failed', err);
          clientIp = null;
        });
    } catch (err) {
      console.warn('fetch not available', err);
      clientIp = null;
    }
  }

  loadClientIp();

  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyHCDKhMagLW7tlHq3dZZ9tPQAZQmA0hMKMut9amF67dEPsoWV1X2RcmSKSFIujp7mD/exec';
  const PUBLIC_KEY_PEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxWwSLTeQoGM5Gvb9yBBJ
7Q4CFpNu3baUSEfm3NJb5LI59HdM66o3h0Sl2RTbwW2Q9zK1kDqLTf/J5kMnwtU9
GKcEuKD1UYWvzZO9C/ekPoKhzMWccdFujIrTeLPJGjncSr0QZ9ZfAoSAYMamdtlR
lfsNZjrUwEL9NsrPd4RMgaYHAI28TlceDhObgZPzjwBPOy0zEQiqW6NA+eQh88ES
/CKvTjFt8E+jZzmFdqPFKHZ56scmThT7VK1IisRCnQFSRKqyKXBBg9C5Qmro7+3p
KiZAS/mG2QMYEwpVeJ5GzvH3ENBgNBps84YivNU0P0OtJ1vz24meWgemkppqadr+
ZwIDAQAB
-----END PUBLIC KEY-----`;

  // ... resto do código (encryptPayload, getClientInfo, etc.)


  

  



  function pemToArrayBuffer(pem) {
    const b64 = pem.replace(/-----[^-]+-----/g, '').replace(/\s+/g, '');
    const raw = atob(b64);
    const buffer = new ArrayBuffer(raw.length);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < raw.length; i++) view[i] = raw.charCodeAt(i);
    return buffer;
  }

   

   async function encryptPayload(payload) {
  // 1) RSA public key (jsrsasign)
  const rsaPub = KEYUTIL.getKey(PUBLIC_KEY_PEM); // RSAKey

  // 2) Plaintext JSON
  const plaintextJson = JSON.stringify(payload);

  // 3) AES-256-CBC key + IV (CryptoJS)
  const aesKey = CryptoJS.lib.WordArray.random(32);  // 32 bytes = 256 bits
  const iv = CryptoJS.lib.WordArray.random(16);      // 16 bytes = 128-bit IV

  const encrypted = CryptoJS.AES.encrypt(plaintextJson, aesKey, {
    iv: iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7
  });

  const ciphertextB64 = encrypted.ciphertext.toString(CryptoJS.enc.Base64);
  const ivB64 = CryptoJS.enc.Base64.stringify(iv);
  const aesKeyB64 = CryptoJS.enc.Base64.stringify(aesKey);

  // 4) RSA-OAEP encrypt AES key base64 with SHA-256 (jsrsasign)
  const hexCipher = rsaPub.encryptOAEP(aesKeyB64, 'sha256'); // hex string
  const wrappedKeyB64 = hextob64(hexCipher); // base64 do ciphertext RSA

  // 5) Formato esperado pelo Code.gs (decryptCiphertext)
  return {
    key: wrappedKeyB64,
    iv: ivB64,
    ciphertext: ciphertextB64
  };
}



  async function sendEncryptedPayload(payload) {
    try {
      const envelope = await encryptPayload(payload);
      await fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(envelope)
      });
      setStatus('Sent test ping');
    } catch (err) {
      console.error('Failed to send encrypted payload', err);
      setStatus('Error sending payload');
    }
  }



  let saveTimeout;

  function getClientInfo() {
    const colorScheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    // ADDED: capture URL, referrer, and UTM params for anonymous analytics
    const href = window.location.href;
    const referrer = document.referrer || '';
    const urlParams = new URLSearchParams(window.location.search || '');
    const utm = {
      utm_source: urlParams.get('utm_source') || '',
      utm_medium: urlParams.get('utm_medium') || '',
      utm_campaign: urlParams.get('utm_campaign') || ''
    };

    return {
      userAgent: navigator.userAgent,
      language: navigator.language,
      languages: navigator.languages,
      platform: navigator.platform,
      deviceMemory: navigator.deviceMemory ?? null,
      hardwareConcurrency: navigator.hardwareConcurrency ?? null,
      timezone: tz,
      colorScheme,
      screen: {
        width: window.screen?.width ?? null,
        height: window.screen?.height ?? null,
        pixelDepth: window.screen?.pixelDepth ?? null
      },
      connection: navigator.connection ? {
        effectiveType: navigator.connection.effectiveType,
        downlink: navigator.connection.downlink,
        rtt: navigator.connection.rtt
      } : null,
      clientIp: clientIp,
     
      // ADDED: anonymous analytics fields
      url: href,
      referrer,
      utm
    };
  }

  function autoSave(isFinal = false) {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      const payload = {
        meta: {
          stay: document.getElementById('stay')?.value || null,
          mins: document.getElementById('mins')?.value || null,
          client: getClientInfo()
        },
        answers: answers,
        sequence: sequence.map(q => q.type === 'star' ? {type:'star', id:q.id} : {type:'fact', q:q.q}),
        pointer: pointer
      };
      if (isFinal) {
        payload.smartScore = smart;
        payload.starIds = sequence.filter(q => q.type === 'star').map(q => q.id);
      }
      const encryptedPayload = {
        clientId,
        timestamp: new Date().toISOString(),
        ...payload
      };

      sendEncryptedPayload(encryptedPayload);
    }, 800);
  }

  async function sendTestRow() {
    const payload = {
      clientId,
      timestamp: new Date().toISOString(),
      meta: { test: true, note: 'manual ping from UI', client: getClientInfo() },
      answers: { sample: { answer: 'ping' } },
      sequence: [{ type: 'info', q: 'connectivity check' }],
      pointer: 0,
      smartScore: 0,
      testPing: true
    };

    setStatus('Sending test ping…');
    await sendEncryptedPayload(payload);
    setStatus('Test ping sent!');
  }

  let clientId = localStorage.getItem('surveyClientId');
  if (!clientId) {
    clientId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
    localStorage.setItem('surveyClientId', clientId);
  }

  const trueFalseQuestions = [
    {type:"tf", q:'A typical cloud can weigh about a million tons.', correct:true},
    {type:"tf", q:'Giraffes face a lightning risk around 30 times higher than humans.', correct:true},
    {type:"tf", q:'Identical twins share the same fingerprints.', correct:false},
    {type:"tf", q:"The Earth's rotation is gradually speeding up.", correct:false},
    {type:"tf", q:'The brain breaks down some of its own cells every day.', correct:true},
    {type:"tf", q:'Mars has a slightly stretched shape, similar to a rugby ball.', correct:true},
    {type:"tf", q:"The universe’s overall colour is known as Cosmic Latte.", correct:true},
    {type:"tf", q:'Water itself isn’t considered wet.', correct:true},
    {type:"tf", q:'One chicken survived for 18 months after losing its head.', correct:true},
    {type:"tf", q:'Your body contains more bacterial cells than human cells.', correct:true},
    {type:"tf", q:"Octopuses have arms rather than true tentacles.", correct:true},
    {type:"tf", q:'Most world maps used in schools distort land sizes.', correct:true},
    {type:"tf", q:'A snail can have more than ten thousand teeth.', correct:true},
    {type:"tf", q:'A lightning bolt can be hotter than the Sun’s surface.', correct:true},
    {type:"tf", q:'Bananas emit small amounts of natural radiation.', correct:true},
    {type:"tf", q:'You cover millions of kilometres in space each day.', correct:true},
    {type:"tf", q:'An A4 sheet can be folded more than eight times.', correct:false},
    {type:"tf", q:'A penguin has been recorded diving beyond 500 metres.', correct:true},
    {type:"tf", q:'A planet made mostly of diamond-like carbon exists.', correct:true},
    {type:"tf", q:'The Moon increases in size each year.', correct:false}
  ];

  const mcQuestions = [
    {type:"mc", q:"Prime factors of 24?", options:["Two and three","Two and four","Three and eight","Two and twelve"], correct:0},
    {type:"mc", q:"Sides of a trapezoid?", options:["Three","Four","Five","Six"], correct:1},
    {type:"mc", q:"A² + B² = C² theorem?", options:["Euclid","Pythagoras","Fermat","Pascal"], correct:1},
    {type:"mc", q:"Degrees in a circle?", options:["180","270","360","365"], correct:2},
    {type:"mc", q:"Yards in a mile?", options:["1000","1760","2000","5280"], correct:1},
    {type:"mc", q:"Majority of breathable air comes from?", options:["Trees","Grass","Oceans","Rainforest algae"], correct:2},
    {type:"mc", q:"Faster: Sound or light?", options:["Sound","Light","Same","Depends"], correct:1},
    {type:"mc", q:"Add this to water to float easier:", options:["Sugar","Salt","Iron","Baking soda"], correct:1},
    {type:"mc", q:"Earth spin mph equator?", options:["500","1000","1500","2000"], correct:1},
    {type:"mc", q:"Elements on periodic table?", options:["92","108","118","124"], correct:2},
    {type:"mc", q:"Universal donor?", options:["AB+","A-","O-","B+"], correct:2},
    {type:"mc", q:"Moons of Neptune?", options:["8","14","27","63"], correct:1},
    {type:"mc", q:"Disease eradicated in 1980?", options:["Polio","Measles","Smallpox","Malaria"], correct:2},
    {type:"mc", q:"First American woman in space?", options:["Tereshkova","Jemison","Sally Ride","Resnik"], correct:2},
    {type:"mc", q:"Pounds in US ton?", options:["1000","2000","2204","2240"], correct:1},
    {type:"mc", q:"Largest bone?", options:["Tibia","Femur","Humerus","Spine"], correct:1},
    {type:"mc", q:"Planets in solar system?", options:["7","8","9","10"], correct:1},
    {type:"mc", q:"Colours in a rainbow?", options:["6","7","8","Indefinite"], correct:1},
    {type:"mc", q:"Astronomer in Bohemian Rhapsody?", options:["Copernicus","Kepler","Galileo","Newton"], correct:2},
    {type:"mc", q:"Which one doesn’t belong on a burger?", options:["Lettuce","Tomato","Onion","Pickles"], correct:3},
{type:"mc", q:"Which one is not used for writing?", options:["Pencil","Pen","Keyboard","Spoon"], correct:3},
{type:"mc", q:"Which one is not a mammal?", options:["Dolphin","Whale","Shark","Human"], correct:2},
{type:"mc", q:"Which one is not a planet?", options:["Mars","Venus","Pluto","Sirius"], correct:3},
{type:"mc", q:"Which one is not a fruit?", options:["Apple","Banana","Carrot","Grape"], correct:2},
{type:"mc", q:"Which one cannot fly?", options:["Eagle","Bat","Penguin","Parrot"], correct:2}
  ];

  const starQuestions = [
{id:"s1", text:"What surprised you most during your time in the Algarve?", tag:"experienced"},
{id:"s2", text:"What everyday thing in the Algarve felt more annoying than it should’ve?", tag:"experienced"},
{id:"s3", text:"What simple thing from home would’ve made your stay in the Algarve easier?", tag:"all"},
{id:"s4", text:"What useful service did you wish existed in the Algarve?", tag:"experienced"},
{id:"s5", text:"What in the Algarve turned out more confusing than expected?", tag:"experienced"},
{id:"s6", text:"What was unexpectedly hard to find in the Algarve?", tag:"experienced"},
{id:"s7", text:"Which daily chore in the Algarve would you happily pay to avoid?", tag:"all"},
{id:"s8", text:"What in the Algarve made you think: ‘This should be quicker’?", tag:"experienced"},
{id:"s9", text:"What in the Algarve felt outdated or slow?", tag:"experienced"},
{id:"s10", text:"What did you miss most from home while in the Algarve?", tag:"all"},
{id:"s11", text:"What activity did you expect to find in the Algarve but didn’t?", tag:"experienced"},
{id:"s12", text:"When in the Algarve did you think: ‘This could work better’?", tag:"experienced"},
{id:"s13", text:"What in the Algarve took too long to figure out?", tag:"experienced"},
{id:"s14", text:"Which local service in the Algarve disappointed you?", tag:"experienced"},
{id:"s15", text:"What would’ve made your stay in the Algarve more comfortable?", tag:"experienced"},
{id:"s16", text:"What felt overpriced in the Algarve?", tag:"experienced"},
{id:"s17", text:"What from home would’ve made your Algarve stay smoother?", tag:"all"}
  ];

  let answers = {}, sequence = [], pointer = 0, timer = null, timeLeft = 30;
  const pdGameId = 'prisonersDilemma';
  const pdDefaultDuration = 60;
  let pdUserInfo = null;
  let pdState = {
    userScore: 0,
    aiScore: 0,
    timeLeft: pdDefaultDuration,
    timerId: null,
    active: false,
    lastUserMove: 'cooperate',
    history: [],
    ended: false
  };
  const snakeGameId = 'snakeClassic';
  let snakeUserInfo = null;
  const blockdudeGameId = 'blockdude';
  let blockdudeUserInfo = null;
  let currentGameCleanup = null;
  const app = document.getElementById('app');

  function esc(t){ return t.replace(/[&<>"']/g, r=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[r])); }
  function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]); }

  // Prisoner's Dilemma helpers
  function pdStopTimer() {
    if (pdState.timerId) {
      clearInterval(pdState.timerId);
      pdState.timerId = null;
    }
  }

  function pdFormatTime(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function pdOutcome(userMove, aiMove) {
    if (userMove === 'attack' && aiMove === 'attack') return [1, 1];
    if (userMove === 'attack' && aiMove === 'cooperate') return [5, 0];
    if (userMove === 'cooperate' && aiMove === 'attack') return [0, 5];
    return [3, 3];
  }

  function renderPrisonersDilemma(containerId = 'pd-root', onContinue = null) {
    const root = document.getElementById(containerId);
    if (!root) return;

    root.innerHTML = `
      <div class="pd-game-outer">
        <div class="pd-game-shell">
          <div class="pd-hud">
            <div class="pd-hud-label">PRISONER&nbsp;FIELD</div>
            <div class="pd-hud-timer" id="pdTimer">01:00</div>
            <div class="pd-hud-scorebox">
              <div class="pd-hud-chip">
                <span>YOU</span>
                <span class="pd-score-value" id="pdUserScore">0</span>
              </div>
              <div class="pd-hud-chip pd-hud-chip-ai">
                <span>AI</span>
                <span class="pd-score-value" id="pdAiScore">0</span>
              </div>
            </div>
          </div>

          <div class="pd-field">
            <div class="pd-cloud" style="left:-40px;"></div>
            <div class="pd-cloud cloud2" style="left:40px;"></div>
            <div class="pd-cloud cloud3" style="left:140px;"></div>

            <div class="pd-field-row">
              <div>
                <div class="pd-character">
                  <div class="pd-face">
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel-eye"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel-eye"></div>
                    <div class="pd-pixel"></div>

                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>

                    <div class="pd-pixel"></div>
                    <div class="pd-pixel-mouth"></div>
                    <div class="pd-pixel-mouth"></div>
                    <div class="pd-pixel-mouth"></div>
                    <div class="pd-pixel"></div>

                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                  </div>
                </div>
                <div class="pd-label-under">YOU</div>
              </div>

              <div class="pd-middle">
                CHOOSE FAST
                <span>Attack = risky · Cooperate = friendly</span>
              </div>

              <div>
                <div class="pd-character pd-character-ai">
                  <div class="pd-face">
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel-eye"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel-eye"></div>
                    <div class="pd-pixel"></div>

                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>

                    <div class="pd-pixel-mouth"></div>
                    <div class="pd-pixel-mouth"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel-mouth"></div>
                    <div class="pd-pixel-mouth"></div>

                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                    <div class="pd-pixel"></div>
                  </div>
                </div>
                <div class="pd-label-under">AI</div>
              </div>
            </div>
          </div>

          <div class="pd-message-box">
            <div id="pdMessage" class="pd-msg pd-msg-info">
              Press START, then tap ATTACK or COOPERATE to score points in 60 seconds.
            </div>
            <div class="pd-history" id="pdHistory"></div>
          </div>
        </div>

        <div class="pd-controls">
          <button id="pdAttack" class="pd-btn">ATTACK</button>
          <button id="pdCooperate" class="pd-btn pd-btn-primary">COOPERATE</button>
          <button id="pdStart" class="pd-btn pd-btn-small">START</button>
        </div>

        <div class="pd-continue-wrap">
          <button id="pdContinue" class="pd-continue-btn">CONTINUE</button>
        </div>
      </div>
    `;

    const timerEl = document.getElementById('pdTimer');
    const userScoreEl = document.getElementById('pdUserScore');
    const aiScoreEl = document.getElementById('pdAiScore');
    const attackBtn = document.getElementById('pdAttack');
    const coopBtn = document.getElementById('pdCooperate');
    const startBtn = document.getElementById('pdStart');
    const msgEl = document.getElementById('pdMessage');
    const historyEl = document.getElementById('pdHistory');
    const continueBtn = document.getElementById('pdContinue');

    function setPdMessage(text, type = 'info') {
      msgEl.textContent = text;
      msgEl.className = 'pd-msg';
      msgEl.classList.add(
        type === 'good' ? 'pd-msg-good' :
        type === 'bad' ? 'pd-msg-bad' :
        type === 'warn' ? 'pd-msg-warn' :
        'pd-msg-info'
      );
    }

    function renderPdHistory() {
      historyEl.innerHTML = pdState.history
        .map(h => `<div class="pd-history-entry"><span>${h.user}</span><span>${h.ai}</span></div>`)
        .join('');
    }

    function updatePdUi() {
      timerEl.textContent = pdFormatTime(pdState.timeLeft);
      userScoreEl.textContent = pdState.userScore;
      aiScoreEl.textContent = pdState.aiScore;
      renderPdHistory();
    }

    function pdEndGame() {
      pdStopTimer();
      pdState.active = false;
      pdState.ended = true;
      attackBtn.disabled = true;
      coopBtn.disabled = true;

      const verdict =
        pdState.userScore > pdState.aiScore ? 'good' :
        pdState.userScore < pdState.aiScore ? 'bad' : 'info';

      if (pdState.userScore === pdState.aiScore) {
        setPdMessage(`Time up! Tie: ${pdState.userScore} - ${pdState.aiScore}.`, verdict);
      } else if (pdState.userScore > pdState.aiScore) {
        setPdMessage(`Time up! You win ${pdState.userScore} vs ${pdState.aiScore}.`, verdict);
      } else {
        setPdMessage(`Time up! AI wins ${pdState.aiScore} vs ${pdState.userScore}.`, verdict);
      }
    }

    function pdPlayRound(userMove) {
      if (!pdState.active || pdState.timeLeft <= 0) return;

      const aiMove = pdState.lastUserMove;
      const [userPts, aiPts] = pdOutcome(userMove, aiMove);

      pdState.userScore += userPts;
      pdState.aiScore += aiPts;
      pdState.lastUserMove = userMove;

      pdState.history.unshift({
        user: `${userMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (+${userPts})`,
        ai: `${aiMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (+${aiPts})`
      });

      setPdMessage(
        `You: ${userMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (${userPts}) · AI: ${aiMove === 'attack' ? 'ATTACK' : 'COOPERATE'} (${aiPts})`,
        userPts >= aiPts ? 'good' : 'bad'
      );

      updatePdUi();
    }

    function startPdGame() {
      pdStopTimer();
      pdState = {
        userScore: 0,
        aiScore: 0,
        timeLeft: pdDefaultDuration,
        timerId: null,
        active: true,
        lastUserMove: 'cooperate',
        history: [],
        ended: false
      };

      attackBtn.disabled = false;
      coopBtn.disabled = false;
      continueBtn.disabled = false;

      setPdMessage('Go! Make the best score in 60 seconds.', 'info');
      updatePdUi();

      pdState.timerId = setInterval(() => {
        pdState.timeLeft--;
        updatePdUi();
        if (pdState.timeLeft <= 0) pdEndGame();
      }, 1000);
    }

    attackBtn.onclick = () => pdPlayRound('attack');
    coopBtn.onclick = () => pdPlayRound('cooperate');
    startBtn.onclick = startPdGame;

    continueBtn.onclick = () => {
      pdStopTimer();
      pdState.ended = true;
      const result = {
        userScore: pdState.userScore,
        aiScore: pdState.aiScore,
        timePlayed: pdDefaultDuration - pdState.timeLeft,
        history: [...pdState.history]
      };

      if (typeof onContinue === 'function') {
        onContinue(result);
      }
    };

    attackBtn.disabled = true;
    coopBtn.disabled = true;
    continueBtn.disabled = false;
    updatePdUi();
  }

  function renderSnakeGame(containerId = 'snake-root', onContinue = null) {
    const root = document.getElementById(containerId);
    if (!root) return () => {};

    root.innerHTML = `
      <div class="sn-game-outer">
        <div class="sn-game-shell">
          <div class="sn-hud">
            <div class="sn-hud-label">SNAKE&nbsp;FIELD</div>
            <div class="sn-hud-middle">Use arrows · Eat apples</div>
            <div class="sn-hud-scorebox">
              <div class="sn-hud-chip">
                <span>SCORE</span>
                <span class="sn-score-value" id="snScore">0</span>
              </div>
            </div>
          </div>

          <div class="sn-field">
            <div class="sn-cloud" style="left:-40px;"></div>
            <div class="sn-cloud c2" style="left:40px;"></div>
            <div class="sn-cloud c3" style="left:140px;"></div>

            <div class="sn-field-row">
              <div class="sn-canvas-wrap">
                <canvas id="snCanvas" class="sn-canvas" width="256" height="256"></canvas>
              </div>
            </div>
          </div>

          <div class="sn-controls">
            <button id="snStart" class="sn-btn sn-btn-primary">START</button>
            <button id="snReset" class="sn-btn sn-btn-small">RESET</button>
          </div>

          <div class="sn-mobile-arrows">
            <div class="sn-arrow-row">
              <button id="snArrowUp" class="sn-arrow-btn">▲</button>
            </div>
            <div class="sn-arrow-row">
              <button id="snArrowLeft" class="sn-arrow-btn">◀</button>
              <button class="sn-arrow-btn sn-arrow-btn-empty" disabled></button>
              <button id="snArrowRight" class="sn-arrow-btn">▶</button>
            </div>
            <div class="sn-arrow-row">
              <button id="snArrowDown" class="sn-arrow-btn">▼</button>
            </div>
          </div>

          <div class="sn-message-box" id="snMessage">
            Press START, then use the arrow keys or buttons. Don't eat yourself.
          </div>

          <div class="sn-continue-wrap">
            <button id="snContinue" class="sn-continue-btn">CONTINUE</button>
          </div>
        </div>
      </div>
    `;

    const canvas = document.getElementById('snCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('snScore');
    const msgEl = document.getElementById('snMessage');
    const startBtn = document.getElementById('snStart');
    const resetBtn = document.getElementById('snReset');
    const continueBtn = document.getElementById('snContinue');

    const arrowUpBtn = document.getElementById('snArrowUp');
    const arrowDownBtn = document.getElementById('snArrowDown');
    const arrowLeftBtn = document.getElementById('snArrowLeft');
    const arrowRightBtn = document.getElementById('snArrowRight');

    const grid = 16;
    let count = 0;
    let running = false;
    let rafId = null;
    let score = 0;
    let startTime = null;

    const snake = {
      x: 5 * grid,
      y: 5 * grid,
      dx: grid,
      dy: 0,
      cells: [],
      maxCells: 4
    };

    const apple = {
      x: 10 * grid,
      y: 10 * grid
    };

    function snSetMessage(text, type) {
      msgEl.textContent = text;
      msgEl.className = 'sn-message-box';
      if (type === 'good') msgEl.classList.add('sn-msg-good');
      else if (type === 'bad') msgEl.classList.add('sn-msg-bad');
      else if (type === 'warn') msgEl.classList.add('sn-msg-warn');
    }

    function snRandomApple() {
      const max = canvas.width / grid;
      apple.x = Math.floor(Math.random() * max) * grid;
      apple.y = Math.floor(Math.random() * max) * grid;
    }

    function snResetGame() {
      score = 0;
      scoreEl.textContent = '0';
      snake.x = 5 * grid;
      snake.y = 5 * grid;
      snake.cells = [];
      snake.maxCells = 4;
      snake.dx = grid;
      snake.dy = 0;
      snRandomApple();
      count = 0;
      startTime = null;
      snSetMessage('Game reset. Press START to play again.', 'info');
    }

    function snChangeDirection(dir) {
      if (!running) return;
      if (dir === 'left' && snake.dx === 0) {
        snake.dx = -grid; snake.dy = 0;
      } else if (dir === 'up' && snake.dy === 0) {
        snake.dy = -grid; snake.dx = 0;
      } else if (dir === 'right' && snake.dx === 0) {
        snake.dx = grid; snake.dy = 0;
      } else if (dir === 'down' && snake.dy === 0) {
        snake.dy = grid; snake.dx = 0;
      }
    }

    function snLoop() {
      rafId = requestAnimationFrame(snLoop);
      if (!running) return;

      if (++count < 4) return;

      count = 0;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#022c22';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#064e3b';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += grid) {
        ctx.beginPath();
        ctx.moveTo(x + 0.5, 0);
        ctx.lineTo(x + 0.5, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += grid) {
        ctx.beginPath();
        ctx.moveTo(0, y + 0.5);
        ctx.lineTo(canvas.width, y + 0.5);
        ctx.stroke();
      }

      snake.x += snake.dx;
      snake.y += snake.dy;

      if (snake.x < 0) snake.x = canvas.width - grid;
      else if (snake.x >= canvas.width) snake.x = 0;

      if (snake.y < 0) snake.y = canvas.height - grid;
      else if (snake.y >= canvas.height) snake.y = 0;

      snake.cells.unshift({ x: snake.x, y: snake.y });
      if (snake.cells.length > snake.maxCells) snake.cells.pop();

      ctx.fillStyle = '#ef4444';
      ctx.fillRect(apple.x + 1, apple.y + 1, grid - 2, grid - 2);

      ctx.fillStyle = '#22c55e';
      snake.cells.forEach(function(cell, index) {
        ctx.fillRect(cell.x + 1, cell.y + 1, grid - 2, grid - 2);

        if (cell.x === apple.x && cell.y === apple.y) {
          snake.maxCells++;
          score++;
          scoreEl.textContent = score.toString();
          snSetMessage('Yum! +1.', 'good');
          snRandomApple();
        }

        for (let i = index + 1; i < snake.cells.length; i++) {
          if (cell.x === snake.cells[i].x && cell.y === snake.cells[i].y) {
            running = false;
            snSetMessage('You ate yourself. Press START or RESET.', 'bad');
            return;
          }
        }
      });
    }

    function stopLoop() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
    }

    function snKeyHandler(e) {
      if (e.key === 'ArrowLeft') snChangeDirection('left');
      else if (e.key === 'ArrowUp') snChangeDirection('up');
      else if (e.key === 'ArrowRight') snChangeDirection('right');
      else if (e.key === 'ArrowDown') snChangeDirection('down');
    }

    document.addEventListener('keydown', snKeyHandler);

    function bindArrow(btn, dir) {
      if (!btn) return;
      const handler = (ev) => {
        ev.preventDefault();
        snChangeDirection(dir);
      };
      btn.addEventListener('touchstart', handler, { passive: false });
      btn.addEventListener('mousedown', handler);
      return () => {
        btn.removeEventListener('touchstart', handler);
        btn.removeEventListener('mousedown', handler);
      };
    }

    const unbinders = [
      bindArrow(arrowUpBtn, 'up'),
      bindArrow(arrowDownBtn, 'down'),
      bindArrow(arrowLeftBtn, 'left'),
      bindArrow(arrowRightBtn, 'right')
    ].filter(Boolean);

    startBtn.onclick = () => {
      if (!rafId) {
        snRandomApple();
        rafId = requestAnimationFrame(snLoop);
      }
      if (!running) {
        running = true;
        if (!startTime) startTime = performance.now();
        snSetMessage('Go! Use the arrow keys or buttons.', 'info');
      }
    };

    resetBtn.onclick = () => {
      running = false;
      stopLoop();
      snResetGame();
    };

    continueBtn.onclick = () => {
      running = false;
      const result = {
        score,
        applesEaten: score,
        timePlayed: startTime ? Math.round((performance.now() - startTime) / 1000) : 0,
        ended: true
      };
      stopLoop();
      snSetMessage('Saved your score. Moving on.', 'info');
      if (typeof onContinue === 'function') {
        onContinue(result);
      }
    };

    snResetGame();

    return function teardownSnakeGame() {
      running = false;
      stopLoop();
      document.removeEventListener('keydown', snKeyHandler);
      unbinders.forEach((fn) => fn());
    };
  }

  function renderBlockDude(containerId = 'blockdude-root', onContinue = null) {
    const root = document.getElementById(containerId);
    if (!root) return () => {};

    root.innerHTML = `
      <div class="bd-game-outer">
        <div class="bd-game-shell">
          <div class="bd-hud">
            <div class="bd-hud-label">BLOCK&nbsp;DUDE</div>
            <div class="bd-hud-middle">Left / Right · Down = pick/drop</div>
            <div class="bd-hud-right">
              <div>Reach the door</div>
            </div>
          </div>

          <div class="bd-field">
            <div class="bd-cloud" style="left:-40px;"></div>
            <div class="bd-cloud c2" style="left:40px;"></div>
            <div class="bd-cloud c3" style="left:140px;"></div>

            <div class="bd-field-row">
              <div class="bd-canvas-wrap">
                <canvas id="bdCanvas" class="bd-canvas" width="384" height="256"></canvas>
              </div>
            </div>
          </div>

          <div class="bd-controls">
            <button id="bdStart" class="bd-btn bd-btn-primary">START</button>
            <button id="bdReset" class="bd-btn bd-btn-small">RESET</button>
          </div>

          <div class="bd-mobile-arrows">
            <div class="bd-arrow-row">
              <button class="bd-arrow-btn bd-arrow-btn-empty" disabled></button>
              <button id="bdArrowDown" class="bd-arrow-btn">▼</button>
              <button class="bd-arrow-btn bd-arrow-btn-empty" disabled></button>
            </div>
            <div class="bd-arrow-row">
              <button id="bdArrowLeft" class="bd-arrow-btn">◀</button>
              <button class="bd-arrow-btn bd-arrow-btn-empty" disabled></button>
              <button id="bdArrowRight" class="bd-arrow-btn">▶</button>
            </div>
          </div>

          <div class="bd-message-box" id="bdMessage">
            Press START, then use keys or buttons. Get to the tiny door.
          </div>

          <div class="bd-continue-wrap">
            <button id="bdContinue" class="bd-continue-btn">CONTINUE</button>
          </div>
        </div>
      </div>
    `;

    const canvas = document.getElementById('bdCanvas');
    const context = canvas.getContext('2d');
    const startBtn = document.getElementById('bdStart');
    const resetBtn = document.getElementById('bdReset');
    const msgEl = document.getElementById('bdMessage');
    const continueBtn = document.getElementById('bdContinue');

    const arrowLeftBtn = document.getElementById('bdArrowLeft');
    const arrowRightBtn = document.getElementById('bdArrowRight');
    const arrowDownBtn = document.getElementById('bdArrowDown');

    const grid = 32;

    const wallCanvas = document.createElement('canvas');
    const wallCtx = wallCanvas.getContext('2d');
    wallCanvas.width = wallCanvas.height = grid;

    wallCtx.fillStyle = 'white';
    wallCtx.fillRect(1, 1, grid, grid);
    wallCtx.fillStyle = 'black';
    wallCtx.fillRect(0, 1, 21, 10);
    wallCtx.fillRect(23, 1, 10, 10);
    wallCtx.fillRect(0, 12, 10, 9);
    wallCtx.fillRect(11, 12, 21, 9);
    wallCtx.fillRect(0, 22, 21, 10);
    wallCtx.fillRect(23, 22, 10, 10);

    let playerDir = { row: 0, col: 0 };
    let playerPos = { row: 0, col: 0 };
    let playerFacing = -1;
    let rAF = null;
    let carryingBlock = false;
    let width = 0;
    let running = false;
    let reachedExit = false;
    let actions = 0;
    let blocksMoved = 0;
    let resets = 0;
    let startTime = null;

    const types = {
      wall: '#',
      player: '@',
      block: '$',
      goal: '.',
      empty: ' '
    };

    const level1 = `
 #    ##        ##
 #                #
##                 #
#.                  #
##                   #
 #           #  $    #
 #           #$ $$@  #
 #####   #############
     #  $#
     #####
`;

    const cells = [];

    function bdSetMessage(text, type) {
      msgEl.textContent = text;
      msgEl.className = 'bd-message-box';
      if (type === 'good') msgEl.classList.add('bd-msg-good');
      else if (type === 'bad') msgEl.classList.add('bd-msg-bad');
      else if (type === 'warn') msgEl.classList.add('bd-msg-warn');
    }

    function buildLevel() {
      width = 0;
      cells.length = 0;
      playerPos = { row: 0, col: 0 };
      playerDir = { row: 0, col: 0 };
      playerFacing = -1;
      carryingBlock = false;
      reachedExit = false;
      actions = 0;
      blocksMoved = 0;
      startTime = null;

      level1.split('\n')
        .filter(rowData => rowData !== '')
        .forEach((rowData, row) => {
          cells[row] = [];
          if (rowData.length > width) width = rowData.length;

          rowData.split('').forEach((colData, col) => {
            cells[row][col] = colData;
            if (colData === types.player) {
              playerPos = { row, col };
            }
          });
        });
    }

    function clamp(min, max, value) {
      return Math.min(Math.max(min, value), max);
    }

    function move(startPos, endPos) {
      const startCell = cells[startPos.row][startPos.col];
      const endCell = cells[endPos.row]?.[endPos.col];

      const isPlayer = startCell === types.player;

      if (startCell === types.player || startCell === types.block) {
        cells[startPos.row][startPos.col] = types.empty;
      }

      if (endCell === types.empty || endCell === types.goal) {
        cells[endPos.row][endPos.col] = isPlayer ? types.player : types.block;
      }

      playerFacing = endPos.col - startPos.col;

      if (carryingBlock) {
        const aboveStart = cells[startPos.row - 1];
        if (aboveStart) aboveStart[startPos.col] = types.empty;
        const aboveEnd = cells[endPos.row - 1];
        if (aboveEnd) aboveEnd[endPos.col] = types.block;
      }
    }

    function loop() {
      rAF = requestAnimationFrame(loop);
      context.clearRect(0, 0, canvas.width, canvas.height);

      if (running) {
        let row = playerPos.row + playerDir.row;
        const col = playerPos.col + playerDir.col;
        const cell = cells[row]?.[col];

        switch(cell) {
          case types.empty:
          case types.goal:
            let rowBelow = row + 1 + playerDir.row;
            let belowCell = cells[rowBelow]?.[col];
            while (belowCell === types.empty || belowCell === types.goal) {
              row = rowBelow;
              rowBelow = row + 1 + playerDir.row;
              belowCell = cells[rowBelow]?.[col];
            }

            move(playerPos, { row, col });

            playerPos.row = row;
            playerPos.col = col;

            if (cell === types.goal) {
              running = false;
              reachedExit = true;
              bdSetMessage('Nice! You reached the exit.', 'good');
            }
            break;

          case types.block:
          case types.wall:
            const rowAbove = row - 1 + playerDir.row;
            const nextCell = cells[rowAbove]?.[col];

            if (nextCell === types.empty || nextCell === types.goal) {
              move(playerPos, { row: rowAbove, col });

              playerPos.row = rowAbove;
              playerPos.col = col;
            }
            break;
        }

        playerDir = { row: 0, col: 0 };
      }

      context.strokeStyle = 'black';
      context.fillStyle = 'black';
      context.lineWidth = 2;

      const startRow = clamp(0, Math.max(0, cells.length - 8), playerPos.row - 4);
      const startCol = clamp(0, Math.max(0, width - 12), playerPos.col - 6);

      for (let row = startRow; row < cells.length; row++) {
        for (let col = startCol; col < (cells[row]?.length || 0); col++) {
          const cell = cells[row][col];
          const drawRow = row - startRow;
          const drawCol = col - startCol;

          switch(cell) {
            case types.wall:
              context.drawImage(wallCanvas, drawCol * grid, drawRow * grid);
              break;

            case types.block:
              context.strokeRect(drawCol * grid, drawRow * grid, grid, grid);
              break;

            case types.goal:
              context.strokeRect((drawCol + 0.2) * grid, drawRow * grid, grid - 12, grid);
              context.beginPath();
              context.arc((drawCol + 0.7) * grid, (drawRow + 0.5) * grid, 2, 0, Math.PI * 2);
              context.fill();
              break;

            case types.player:
              context.beginPath();
              context.arc((drawCol + 0.5) * grid, (drawRow + 0.3) * grid, 7, 0, Math.PI * 2);
              context.stroke();

              const x = (drawCol + ( playerFacing < 0 ? 0.1 : 0.6)) * grid;
              context.fillRect(x, (drawRow + 0.15) * grid, grid / 3, 2);
              context.beginPath();
              context.arc((drawCol + 0.5) * grid, (drawRow + 0.25) * grid, 7, 0, Math.PI, 1);
              context.fill();

              context.fillRect((drawCol + 0.48) * grid, (drawRow + 0.4) * grid, 2, grid / 2.5 );
              context.fillRect((drawCol + 0.3) * grid, (drawRow + 0.6) * grid, grid / 2.5, 2);

              context.moveTo((drawCol + 0.5) * grid, (drawRow + 0.8) * grid);
              context.lineTo((drawCol + 0.65) * grid, (drawRow + 1) * grid);
              context.moveTo((drawCol + 0.5) * grid, (drawRow + 0.8) * grid);
              context.lineTo((drawCol + 0.35) * grid, (drawRow + 1) * grid);
              context.stroke();
              break;
          }
        }
      }
    }

    function handleInput(dir) {
      if (!running) return;
      if (!startTime) startTime = performance.now();

      playerDir = { row: 0, col: 0 };
      let acted = false;

      if (dir === 'left') {
        playerDir.col = -1;
        acted = true;
      } else if (dir === 'right') {
        playerDir.col = 1;
        acted = true;
      } else if (dir === 'down') {
        const nextCol = playerFacing + playerPos.col;
        const rowLength = cells[playerPos.row]?.length || 0;
        if (nextCol < 0 || nextCol >= rowLength) return;
        const nextCell = cells[playerPos.row]?.[nextCol];
        const cellAbove = cells[playerPos.row - 1]?.[nextCol];

        if (!carryingBlock && nextCell === types.block && cellAbove === types.empty) {
          cells[playerPos.row][nextCol] = types.empty;
          cells[playerPos.row - 1][playerPos.col] = types.block;
          carryingBlock = true;
          blocksMoved++;
          acted = true;
          bdSetMessage('Block picked up.', 'info');
        } else if (carryingBlock) {
          let row = playerPos.row;

          if (nextCell === types.empty) {
            let rowBelow = row - 1;
            let belowCell = cells[rowBelow]?.[nextCol];
            while (belowCell === types.empty) {
              row = rowBelow;
              rowBelow++;
              belowCell = cells[rowBelow]?.[nextCol];
            }
          }

          if ((nextCell === types.wall || nextCell === types.block) && cellAbove === types.empty) {
            row = row - 1;
          }

          cells[playerPos.row - 1][playerPos.col] = types.empty;
          cells[row][nextCol] = types.block;
          carryingBlock = false;
          blocksMoved++;
          acted = true;
          bdSetMessage('Block dropped.', 'info');
        }
      }

      if (acted) actions++;
    }

    function keyHandler(e) {
      const key = e.key || e.code;
      if (key === 'ArrowLeft' || e.which === 37) {
        e.preventDefault();
        handleInput('left');
      } else if (key === 'ArrowRight' || e.which === 39) {
        e.preventDefault();
        handleInput('right');
      } else if (key === 'ArrowDown' || e.which === 40) {
        e.preventDefault();
        handleInput('down');
      }
    }

    document.addEventListener('keydown', keyHandler);

    function bindArrow(btn, dir) {
      if (!btn) return () => {};
      const handler = (ev) => {
        ev.preventDefault();
        handleInput(dir);
      };
      btn.addEventListener('touchstart', handler, { passive: false });
      btn.addEventListener('mousedown', handler);
      return () => {
        btn.removeEventListener('touchstart', handler);
        btn.removeEventListener('mousedown', handler);
      };
    }

    const unbinders = [
      bindArrow(arrowLeftBtn, 'left'),
      bindArrow(arrowRightBtn, 'right'),
      bindArrow(arrowDownBtn, 'down'),
    ];

    function stopLoop() {
      if (rAF) cancelAnimationFrame(rAF);
      rAF = null;
    }

    startBtn.onclick = () => {
      if (!rAF) rAF = requestAnimationFrame(loop);
      running = true;
      if (!startTime) startTime = performance.now();
      bdSetMessage('Go! Use arrows or buttons.', 'info');
    };

    resetBtn.onclick = () => {
      running = false;
      resets++;
      buildLevel();
      bdSetMessage('Level reset. Try again.', 'info');
      if (!rAF) rAF = requestAnimationFrame(loop);
    };

    continueBtn.onclick = () => {
      const result = {
        moves: actions,
        blocksMoved,
        resets,
        completed: reachedExit,
        timePlayed: startTime ? Math.round((performance.now() - startTime) / 1000) : 0
      };
      running = false;
      stopLoop();
      bdSetMessage('Saved your progress. Moving on.', 'info');
      if (typeof onContinue === 'function') {
        onContinue(result);
      }
    };

    buildLevel();
    rAF = requestAnimationFrame(loop);

    return function teardownBlockDude() {
      running = false;
      stopLoop();
      document.removeEventListener('keydown', keyHandler);
      unbinders.forEach((fn) => fn());
    };
  }

  function renderMeta() {
    app.innerHTML = `
      <div class="container flex flex-col justify-center items-center h-full px-6">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl p-8 w-full max-w-md">
          <h1 class="text-4xl font-black text-center mb-10">How Smart are You?</h1>
          <div class="space-y-8">
            <div>
              <label class="block text-xl font-semibold mb-3">Staying in Algarve?</label>
              <select id="stay" class="w-full p-5 rounded-2xl border-[3px] border-slate-300 dark:border-slate-700 dark:bg-slate-800 text-lg">
                <option value="leaving">Leaving soon</option>
                <option value="few">Few more days</option>
                <option value="just">Just arrived</option>
                <option value="not">Not here</option>
              </select>
            </div>

            <div>
              <label class="block text-xl font-semibold mb-3">How Bored are you? (1-10)</label>
              <input id="mins" type="range" min="1" max="10" value="5" class="w-full">
              <div class="text-center text-5xl font-bold mt-4"><span id="minsVal">5</span></div>
            </div>

            <div class="space-y-3">
              <button id="start" class="w-full py-6 bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-bold rounded-3xl shadow-xl">Start</button>
            </div>
          </div>
        </div>
      </div>`;

    document.getElementById('mins').oninput = e => {
      document.getElementById('minsVal').textContent = e.target.value;
      autoSave();
    };

    document.getElementById('stay').onchange = () => autoSave();
    document.getElementById('start').onclick = startSurvey;
  }

  function startSurvey() {
    const mins = +document.getElementById('mins').value;
    const stay = document.getElementById('stay').value;

    const maxF = mins < 4 ? 5 : mins < 7 ? 10 : 16;
    const maxS = mins < 4 ? 2 : mins < 7 ? 5 : 8;

    const stars = shuffle(starQuestions.filter(q => q.tag === 'all' || (q.tag === 'experienced' && stay !== 'just'))).slice(0, maxS);

    const facts = shuffle([
      ...trueFalseQuestions.map(f => ({...f,isTF:true})),
      ...mcQuestions.map(f => ({...f,isTF:false}))
    ]).slice(0, maxF);

    sequence = [];
    let streak = 0, si = 0;

    facts.forEach(f => {
      sequence.push({type:'fact', q:f.q, options:f.options||null, correct:f.correct, isTF:f.isTF});
      streak++;
      if ((streak >= 2 && Math.random()<0.7) || streak >= 3) {
        if (si < stars.length) {
          sequence.push({type:'star', id:stars[si].id, text:stars[si].text});
          si++;
          streak = 0;
        }
      }
    });

    while (si < stars.length) {
      sequence.push({type:'star', id:stars[si].id, text:stars[si].text});
      si++;
    }

    // ADDED: insert mini-games between questions
    if (sequence.length > 1) {
      const gameIds = [pdGameId, snakeGameId, blockdudeGameId];
      const slotSize = Math.max(1, Math.floor(sequence.length / (gameIds.length + 1)));

      gameIds.forEach((id, index) => {
        const position = Math.min(sequence.length, Math.max(1, slotSize * (index + 1) + index));
        sequence.splice(position, 0, { type: 'game', id });
      });
    }

    pointer = 0;
    answers = {};
    renderQuestion();
    autoSave();
  }

  function startTimer() {
    timeLeft = 30;
    updateTimer();
    clearInterval(timer);
    timer = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        clearInterval(timer);
        answers[sequence[pointer].q] = {answer:null, timedOut:true};
        autoSave();
        next();
      }
    }, 1000);
  }

  function updateTimer() {
    const ring = document.getElementById('ring');
    const num = document.getElementById('time');
    if (!ring) return;
    const c = 1356;
    ring.style.strokeDashoffset = c - (timeLeft/30)*c;
    num.textContent = timeLeft;
    ring.style.stroke = timeLeft > 10 ? '#10b981' : timeLeft > 5 ? '#f59e0b' : '#ef4444';
  }

  function renderQuestion() {
      pdStopTimer();
      if (currentGameCleanup) {
        currentGameCleanup();
        currentGameCleanup = null;
      }
      const q = sequence[pointer];
      const progress = Math.round(((pointer + 1) / sequence.length) * 100);

    app.innerHTML = `
      <div class="container flex flex-col h-full">
        <div class="flex justify-between items-center py-4 px-6">
          <button id="back" class="text-3xl">←</button>
          <div class="text-lg font-bold">${pointer+1}/${sequence.length}</div>
          <div class="w-32 h-2 bg-gray-300 dark:bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full bg-indigo-600 transition-all duration-300" style="width:${progress}%"></div>
          </div>
        </div>

        <div class="flex-1 flex flex-col justify-center px-6">
          ${q.type === 'fact' ? `
            <div class="text-center mb-8">
              <svg width="90" height="90" viewBox="0 0 480 480" class="mx-auto">
                <circle cx="240" cy="240" r="216" stroke="#e2e8f0" stroke-width="36" fill="none" class="dark:stroke-[#334155]"/>
                <circle id="ring" cx="240" cy="240" r="216" stroke="#10b981" stroke-width="36" fill="none" stroke-dasharray="1356" style="stroke-dashoffset:1356" class="timer-ring"/>
                <text id="time" x="240" y="280" font-size="120" text-anchor="middle" font-weight="bold" fill="currentColor">30</text>
              </svg>
              <h2 class="text-2xl font-black leading-tight mt-6">${esc(q.q)}</h2>
            </div>

            <div class="space-y-3 mt-auto">
              ${q.isTF ? `
                <button class="true w-full py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-3xl shadow-xl">TRUE</button>
                <button class="false w-full py-6 bg-gradient-to-r from-red-500 to-rose-600 text-white text-2xl font-bold rounded-3xl shadow-xl">FALSE</button>
              ` : q.options.map((o,i) => `
                <button data-i="${i}" class="option w-full py-5 text-xl font-medium bg-white dark:bg-slate-800 border-[3px] border-gray-300 dark:border-slate-700 rounded-2xl hover:border-indigo-500 dark:hover:border-indigo-400 transition">${esc(o)}</button>
              `).join('')}
            </div>
          ` : q.type === 'game' ? `
            <div class="flex-1 flex flex-col items-center justify-center px-2 space-y-2">
              ${q.id === pdGameId ? `
                <div id="pd-root" class="flex-1 flex items-center justify-center w-full px-2"></div>
                <div id="pd-user-summary" class="text-xs text-center text-slate-600 dark:text-slate-200"></div>
              ` : q.id === snakeGameId ? `
                <div id="snake-root" class="flex-1 flex items-center justify-center w-full px-2"></div>
                <div id="snake-user-summary" class="text-xs text-center text-slate-600 dark:text-slate-200"></div>
              ` : `
                <div id="blockdude-root" class="flex-1 flex items-center justify-center w-full px-2"></div>
                <div id="blockdude-user-summary" class="text-xs text-center text-slate-600 dark:text-slate-200"></div>
              `}
            </div>
          ` : `
            <div class="flex-1 flex flex-col justify-center">
              <h2 class="text-2xl font-black leading-tight mb-6">${esc(q.text)}</h2>
              <textarea id="txt" class="flex-1 min-h-0 p-5 text-lg rounded-2xl border-[3px] border-gray-300 dark:border-slate-700 dark:bg-slate-800 focus:border-indigo-500 outline-none resize-none" placeholder="Your answer...">${answers[q.id]?.answer||''}</textarea>
              <button id="nextStar" class="mt-6 w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold rounded-2xl shadow-xl">Next</button>
            </div>
          `}
        </div>
      </div>`;

    const ring = document.getElementById('ring');
    if (ring) ring.style.strokeDashoffset = 1356;

    if (q.type === 'fact') startTimer();

    if (q.type === 'fact' && q.isTF) {
      document.querySelector('.true').onclick = () => choose(true);
      document.querySelector('.false').onclick = () => choose(false);
    }

    if (q.type === 'fact' && !q.isTF) {
      document.querySelectorAll('.option').forEach(b => {
        b.onclick = () => {
          document.querySelectorAll('.option').forEach(x => x.classList.remove('border-indigo-500','bg-indigo-50','dark:bg-indigo-900'));
          b.classList.add('border-indigo-500','bg-indigo-50','dark:bg-indigo-900');
          choose(+b.dataset.i);
        };
      });
    }

    if (q.type === 'game') {
      if (q.id === pdGameId) {
        pdState = {
          userScore: 0,
          aiScore: 0,
          timeLeft: pdDefaultDuration,
          timerId: null,
          active: false,
          lastUserMove: 'cooperate',
          history: [],
          ended: false
        };

        const summaryEl = document.getElementById('pd-user-summary');
        if (summaryEl) {
          summaryEl.textContent = pdUserInfo
            ? `Previous round: You ${pdUserInfo.userScore} · AI ${pdUserInfo.aiScore} in ${pdFormatTime(pdUserInfo.timePlayed)}.`
            : 'Play a round, then tap CONTINUE to move on.';
        }

        renderPrisonersDilemma('pd-root', (result) => {
          pdUserInfo = {
            ...result,
            ended: pdState.ended
          };

          if (summaryEl) {
            summaryEl.textContent = `You scored ${result.userScore} while AI scored ${result.aiScore} in ${pdFormatTime(result.timePlayed)}.`;
          }

          next();
        });

        currentGameCleanup = () => pdStopTimer();
      } else if (q.id === snakeGameId) {
        const summaryEl = document.getElementById('snake-user-summary');
        if (summaryEl) {
          summaryEl.textContent = snakeUserInfo
            ? `Previous round: ${snakeUserInfo.applesEaten ?? snakeUserInfo.score} apples in ${snakeUserInfo.timePlayed}s.`
            : 'Press START, use the arrows or buttons, then CONTINUE to proceed.';
        }

        const teardown = renderSnakeGame('snake-root', (result) => {
          snakeUserInfo = { ...result };
          if (summaryEl) {
            summaryEl.textContent = `You ate ${result.applesEaten} apples in ${result.timePlayed}s.`;
          }
          next();
        });

        currentGameCleanup = teardown;
      } else if (q.id === blockdudeGameId) {
        const summaryEl = document.getElementById('blockdude-user-summary');
        if (summaryEl) {
          summaryEl.textContent = blockdudeUserInfo
            ? `${blockdudeUserInfo.completed ? 'Reached exit' : 'Not yet at exit'} in ${blockdudeUserInfo.timePlayed}s after ${blockdudeUserInfo.moves} moves.`
            : 'Press START, move with arrows or the down button, then CONTINUE to proceed.';
        }

        const teardown = renderBlockDude('blockdude-root', (result) => {
          blockdudeUserInfo = { ...result };
          if (summaryEl) {
            const status = result.completed ? 'Reached exit' : 'Stopped early';
            summaryEl.textContent = `${status} in ${result.timePlayed}s after ${result.moves} moves (blocks moved: ${result.blocksMoved}).`;
          }
          next();
        });

        currentGameCleanup = teardown;
      }
    }

    if (q.type === 'star') {
      const textarea = document.getElementById('txt');
      textarea.addEventListener('input', () => {
        answers[q.id] = {answer: textarea.value.trim()};
        autoSave();
      });

      document.getElementById('nextStar').onclick = () => {
        answers[q.id] = {answer: textarea.value.trim()};
        autoSave();
        next();
      };
    }

    document.getElementById('back').onclick = () => {
      if (pointer > 0) {
        clearInterval(timer);
        pointer--;
        renderQuestion();
      }
    };
  }

  function choose(val) {
    clearInterval(timer);
    answers[sequence[pointer].q] = {answer: val};
    autoSave();
    next();
  }

  function next() {
    pointer++;
    autoSave();
    if (pointer >= sequence.length) finish();
    else renderQuestion();
  }

  let smart = 0;

  function finish() {
    clearInterval(timer);

    const facts = sequence.filter(x => x.type === 'fact');

    let correct = 0;
    let recap = '';

    facts.forEach(f => {
      const a = answers[f.q] || {answer:null};
      if (a.answer === f.correct) correct++;

      const user = a.answer === null ? 'Timed out' : f.isTF ? (a.answer ? 'True' : 'False') : f.options[a.answer];
      const corr = f.isTF ? (f.correct ? 'True' : 'False') : f.options[f.correct];

      recap += `
        <div class="p-4 bg-white/80 dark:bg-slate-800/80 rounded-xl mb-3">
          <strong class="block mb-1">${esc(f.q)}</strong>
          <div>You: ${user} | Correct: ${corr}</div>
        </div>`;
    });

    smart = facts.length ? Math.round(correct / facts.length * 100) : 0;
    autoSave(true);

    app.innerHTML = `
      <div class="container flex flex-col h-full px-6 pt-8 overflow-y-auto">
        <h1 class="text-5xl font-black text-center mb-8">Results</h1>

        <div class="grid grid-cols-1 gap-5 mb-8">
          <div class="bg-indigo-100 dark:bg-indigo-900 p-6 rounded-3xl text-center">
            <div class="text-xl font-bold">Smart</div>
            <div class="text-6xl font-black">${smart}</div>
          </div>
        </div>

        <div class="space-y-3 flex-1 overflow-y-auto">${recap}</div>

        <button onclick="location.reload()" class="w-full py-5 bg-indigo-600 text-white text-xl font-bold rounded-2xl shadow-xl mt-6">Retake Survey</button>
      </div>`;
  }

  renderMeta();
})();
</script>

<!-- ADDED setStatus FUNCTION -->
<script>
function setStatus(text) {
  const el = document.getElementById('status');
  if (el) el.textContent = text;
}
</script>

</body>
</html>
